<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Feed Manager</title>

    <!-- Speed optimization -->
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Meta -->
    <meta charset="utf-8" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
    <link href="https://www.canada.ca/etc/designs/canada/wet-boew/assets/favicon.ico" rel="icon" type="image/x-icon" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/eventemitter3/4.0.7/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.2/async.min.js"></script>

    <script src="../lib/aem-ml-simple.js"></script>

</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item"><a href="index.html">Maple Leaf</a></li>
                    <li class="breadcrumb-item" aria-current="page">Feed Generator 2 &nbsp;<span class="badge rounded-pill bg-warning">In Development</span></li>
                </ol>
            </nav>

            <h2 class="h5">Type of scan</h2>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="type" value="new">
                <label class="form-check-label" for="flexCheckDefault">very fast <small class="text-muted"> - new articles only</small></label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="type" checked="checked" value="smart">
                <label class="form-check-label" for="flexCheckDefault">fast <small class="text-muted"> - new & modified articles (recommended)</small></label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="type" value="full">
                <label class="form-check-label" for="flexCheckDefault">full <small class="text-muted"> - all articles</small></label>
            </div>

            <div id="progressbar" class="progress mb-2 mt-3" style="height: 5px">
                <div id="complete" class="progress-bar" style="width:0%"></div>
                <div id="active" class="progress-bar bg-warning" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:main()">Click here to start</a></p>

        </div>
    </main>

    <script>

        // Configuration
        var config = {
            roots: [
                'en/department-national-defence/maple-leaf',
                'fr/ministere-defense-nationale/feuille-derable',
            ],
            feeds: [
                'content/dam/dnd-mdn/documents/json/maple-en.json',
                'content/dam/dnd-mdn/documents/json/maple-fr.json',
                //'content/dam/dnd-mdn/documents/json/maple-en-2021.json',
                //'content/dam/dnd-mdn/documents/json/maple-fr-2021.json',
                //'content/dam/dnd-mdn/documents/json/maple-en-2020.json',
                //'content/dam/dnd-mdn/documents/json/maple-fr-2020.json',
                //'content/dam/dnd-mdn/documents/json/maple-en-2019.json',
                //'content/dam/dnd-mdn/documents/json/maple-fr-2019.json',
            ],
            preFilter: function (node) {
                return /\/\d{4}\/\d{2}\/[^/]+$/.test(node.path)
            },
            preNormalize: function (path) {
                return path
                    .replace('{e}', '/en/department-national-defence/maple-leaf')
                    .replace('{f}', '/fr/ministere-defense-nationale/feuille-derable')
            }
        }

        aem.preNormalize = config.preNormalize
        var start = 0

        function status(message) {
            if (message) {
                var time = ((new Date().getTime() - start) / 1000).toFixed(2)

                $('#status').html(message)
                console.info(time, message)
            }

            var p = aem.progress()
            $('#complete').width(p.complete)
            $('#active').width(p.active)
        }

        function main() {

            start = new Date().getTime()
            var type = $('input[name="type"]:checked').val()

            // Load sitemaps & feeds
            status('Downloading node lists')
            var chain = aem.addRoot(config.roots).addFeed(config.feeds).wait()

            // Pre filter node list
            chain.then(function () {

                if (typeof config.preFilter === 'function') {
                    aem.each(config.preFilter)
                }

                // Remove nodes not in sitemap
                aem.each(function (node) {
                    return Boolean(node.lastmod)
                })
                
            })

            // Option: clear all feed data
            if (type === 'full') {
                chain.then(function () {
                    aem.each(function (node) {
                        delete node.live
                        return node
                    })
                })
            }

            // Option: clear data for modified nodes
            if (type === 'smart') {
                chain.then(function () {
                    var now = Date.now() / 1000
                    aem.each(function (node) {
                        if (node.live && node.lastmod > now - 86400) {
                            delete node.live
                            return node
                        }
                    })
                })
            }

            // Load node data
            chain.then(function () {
                status('Downloading nodes')

                // Find nodes to load
                var list = aem.nodes().filter(function (path) {
                    return !aem.data[path].live
                })

                return aem.meta(list).wait()

            }).then(function () {
                status('Verifying node data')

                // Verify peers exist and are loaded
                aem.each(function (node) {
                    if (node.peer) {
                        if (!aem.data[node.peer]) {
                            console.warn('Missing peer', node.path)
                            return false
                        } else if (!aem.data[node.peer].gcGuid) {
                            aem.meta(node.peer)
                        }
                    }
                })

                // Verify circular peer reference
                if (!aem.idle()) {
                    return aem.wait()
                }

            }).then(function () {

                // Verify circular peer reference
                aem.each(function (node) {
                    if (node.peer) {
                        if (!aem.data[node.peer]) {
                            return false
                        } else if (node.path !== aem.data[node.peer].peer) {
                            console.warn('Peer mismatch', node.path)
                            return false
                        }
                    }
                })

            }).then(function () {
                status('Formatting feed entries')
                var now = Math.floor(Date.now() / 1000)

                aem.each(function (node) {
                    if (node.peer) {
                        try {
                            var peer = aem.data[node.peer]

                            node.live = [
                                (node.gcOGImage || '').trim(),
                                '<a href="/' + node.path + '.html">' + node['jcr:title'].trim() + '</a>',
                                (node.gcDescription || '').replace(/[\n\r]+/g, ' ').trim(),
                                (node.gcKeywords || '').trim(),
                                aem.date(node, peer),
                                now
                            ]
                            return node
                        } catch (e) {
                            console.warn('failed live', node)
                        }
                    }
                })
            }).then(function () {
                status('Exporting feeds')
                feeds = { en: [], fr: [] }

                // Sort nodes into feeds
                aem.each(function (node) {
                    if (node.live) {
                        var lang = node['jcr:language'] || node.path.slice(0, 2)
                        feeds[lang].push(node.live)
                    }
                })

                for (lang in feeds) {
                    var json = utf8.encode(JSON.stringify({ data: feeds[lang] }, null, 1))
                    download(json, 'maple-' + lang + '.json', 'text/plain;charset=UTF-8;')
                }

            })


        }

        setInterval(status, 250)

    </script>

</body>

</html>