<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Feed Manager</title>

    <!-- Speed optimization -->
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Meta -->
    <meta charset="utf-8" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
    <link href="https://www.canada.ca/etc/designs/canada/wet-boew/assets/favicon.ico" rel="icon" type="image/x-icon"/>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/eventemitter3/4.0.7/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.2/async.min.js"></script>

    <script src="../lib/aem-ml.js"></script>

</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item"><a href="index.html">Maple Leaf</a></li>
                    <li class="breadcrumb-item" aria-current="page">Feed Generator</li>
                </ol>
            </nav>

            <p>Compiles a listing of Maple Leaf article metadata used in the <a href="https://www.canada.ca/en/department-national-defence/maple-leaf/search.html" target="_blank">search</a> table.</p>


            <div id="progressbar" class="progress my-2" style="height: 5px">
                <div id="complete" class="progress-bar" style="width:0%"></div>
                <div id="active" class="progress-bar bg-warning" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:main()">Click here to start</a></p>

        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            roots: [
                'en/department-national-defence/maple-leaf',
                'fr/ministere-defense-nationale/feuille-derable',
            ],
            feeds: [
                'content/dam/dnd-mdn/documents/json/maple-en-2021.json',
                'content/dam/dnd-mdn/documents/json/maple-fr-2021.json',
                'content/dam/dnd-mdn/documents/json/maple-en-2020.json',
                'content/dam/dnd-mdn/documents/json/maple-fr-2020.json',
                'content/dam/dnd-mdn/documents/json/maple-en-2019.json',
                'content/dam/dnd-mdn/documents/json/maple-fr-2019.json',
            ],
            match: /\/\d{4}\/\d{2}\/[^/]+$/,
        }

        function status(message) {
            if (message) { $('#status').html(message) }
            
            var p = aem.progress()
            $('#complete').width(p.complete)
            $('#active').width(p.active)
        }

  
        status('Finding nodes')

        // Load feeds & sitemaps
        var lists = aem.children(config.roots).feed(config.feeds).drain()
        
        // Filter out non matching
        var x = lists.then(function () {
            aem.filter(config.match)
            status('Found ' + aem.nodes().length + ' nodes')
            return aem
        })

        console.log(x)

        // Load nodes missing from feeds
        lists.then(function() {
            var list = aem.nodes().filter(function(path){
                return !aem.data[path].live
            })

            //aem.htmlmeta(list) //.meta(list, 'gcModifiedOverride')

            console.log('Missing', list)
        })
       

        
        setInterval(status, 250)


     




  
     /*
        AEM.descendantsObj(config.root).done(function (list) {
         
            // Filter out paths that don't match
            list = list.filter(function (node) {
                return config.match.test(node.path)
            })

            AEM.htmlMeta(list[10].path, function (meta) {
                $.extend(list[10], meta)

                console.log(list[10])

            })


        }).fail(function (e) {
            status('Error (' + e + '): ' + config.root)
        })












       
        // Current progress percentage
        var progress = 0
        var started = null

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') {
                progress = percent === 100 ? 100 : progress + percent
                return $progress.width(progress + '%')
            }
        }

        // Display current status of english JSON
        AEM.assetMeta(config.aem_en, function (jcr) {
            var html = jcr['dam:assetState'].charAt(0).toUpperCase() + jcr['dam:assetState'].slice(1) + ' '
            html += '<abbr title="' + jcr['jcr:lastModified'] + '" class="text-primary">' + $.timeago(new Date(jcr['jcr:lastModified'])) + '</abbr>'
            html += ' by <span class="text-primary">' + jcr['jcr:lastModifiedBy'] + '</span>'
            $('#enstatus').html(html)
        }).fail(function (e) {
            if (e === 'Not Found') { e = 'Not Published' }
            $('#enstatus').html('Error (' + e + ')')
        })

        // Display current status of french JSON
        AEM.assetMeta(config.aem_fr).done(function (jcr) {
            var html = jcr['dam:assetState'].charAt(0).toUpperCase() + jcr['dam:assetState'].slice(1) + ' '
            html += '<abbr title="' + jcr['jcr:lastModified'] + '" class="text-primary">' + $.timeago(new Date(jcr['jcr:lastModified'])) + '</abbr>'
            html += ' by <span class="text-primary">' + jcr['jcr:lastModifiedBy'] + '</span>'
            $('#frstatus').html(html)
        }).fail(function (e) {
            if (e === 'Not Found') { e = 'Not Published' }
            $('#frstatus').html('Error (' + e + ')')
        })

        // Define response fields
        var fields = [

            // Thumbnail image URL
            function (meta) {
                if (!meta['og:image']) { return '' }
                var val = utf8.encode($.trim(meta['og:image']))
                return val.replace('https://www.canada.ca/content/dam/dnd-mdn/images/maple-leaf', '{a}')
            },

            // Title (containing link)
            function (meta) {
                if (!meta['path'] || !meta['dcterms.title']) { return '' }
                var val = '<a href="' + AEM.normalize(meta['path']).replace('https://www.canada.ca/','/') + '.html">' + utf8.encode($.trim(meta['dcterms.title'])) + '</a>'

                if (year != cyear) {
                    val = val.replace('/fr/ministere-defense-nationale/feuille-derable', '{f}').replace('/en/department-national-defence/maple-leaf', '{e}')
                }

                return val
            },

            // Description
            function (meta) {
                if (!meta['description']) { return '' }
                return utf8.encode($.trim(meta['description'].replace(/[\r\n]+/gm, ' ')).replace(/\.$/, ''))
            },

            // Tags
            function (meta) {
                if (!meta['keywords']) { return '' }
                return utf8.encode(meta['keywords'].split(',').map(function (tag) {
                    return tag.trim()
                }).filter(function (tag) {
                    return tag ? !tag.match(/(featured|vedette)$/i) : false
                }).filter(function (tag, index, self) {
                    return self.indexOf(tag) === index
                }).join(','))
            },

            function (meta) {
                return meta['date'].toISOString().replace('.000Z', '')
            }

        ]

        // Run program
        function main() {
            started = new Date().getTime()
            status('Initializing', 1)

            AEM.descendants(config.root).done(function (urls) {
                urls = urls.filter(isArticle)
                status('Downloading metadata (' + (urls.length * 2) + ' nodes)')

                withData(urls, function (data) {
                    var en = []
                    var fr = []

                    data.forEach(function (d) {
                        en.push(d[0])
                        fr.push(d[1])
                    })

                    exportData(en, fr)
                })

            }).fail(function (e) {
                status('Error (' + e + '): ' + config.root)
            })
        }

        // Test if URL is an article
        function isArticle(url) {
            return new RegExp('\/' + year + '\/\\d{2}\/[^/]+$', 'i').test(url)
        }

        // Get all meta + dates
        function withData(urls, cb) {
            return $.Deferred(function (d) {
                $.when(
                    withMeta(urls),
                    withDate(urls)
                ).done(function (meta, date) {
                    d.resolve(meta.map(function (m, i) {
                        m[0].date = date[i]
                        m[1].date = date[i]
                        m[0] = fields.map(function (fn) { return fn(m[0]) })
                        m[1] = fields.map(function (fn) { return fn(m[1]) })
                        return m
                    }))
                })
            }).done(cb).promise()
        }

        // Get all html metadata
        function withMeta(urls, cb) {
            return $.Deferred(function (d) {
                $.when.apply(null, urls.map(function (url) {
                    return AEM.htmlMetaPair(url).done(function () {
                        status(null, 49 / urls.length)
                    })
                })).done(function () {
                    d.resolve(Array.prototype.slice.call(arguments))
                })
            }).done(cb).promise()
        }

        // get all page dates
        function withDate(urls, cb) {
            return $.Deferred(function (d) {
                $.when.apply(null, urls.map(function (url) {
                    return AEM.date(url).done(function () {
                        status(null, 49 / urls.length)
                    })
                })).done(function () {
                    d.resolve(Array.prototype.slice.call(arguments))
                })
            }).done(cb).promise()
        }

        // Format feeds and trigger downloads
        function exportData(en, fr) {
            status('Done (' + en.length + ' articles, ' + (Math.round((new Date().getTime() - started) / 100) / 10) + ' seconds)', 100)

            download(JSON.stringify({ data: en }, null, 2), 'maple-en-' + year + '.json', 'text/plain;charset=UTF-8;')
            download(JSON.stringify({ data: fr }, null, 2), 'maple-fr-' + year + '.json', 'text/plain;charset=UTF-8;')
        }
        */
    </script>

</body>

</html>