<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Feed</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>

</head>

<body id="body">

    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5">
                <a href="../index.html">ADMPA Web Tools</a>
                <small class="text-muted">&gt; Maple Leaf &gt; Feed</small>
            </h1>

            <!-- Description -->
            <p>Compiles a list of Maple Leaf pages, merges content from Wordpress articles and AEM pages. The resulting
                JSON files will be downloaded automatically.</p>
            <p>Replace the exsting files in the DAM folder:
                <code><a href="https://author-canada-prod.adobecqms.net/assets.html/content/dam/dnd-mdn/documents/json" target="_blank">/content/dam/dnd-mdn/documents/json/</code></a>
            </p>

            <!-- Status and Progress -->
            <p class="mt-4 mb-0">
                Last published
                <abbr id="modified" class="text-primary">…</abbr> by <em id="modifiedby" class="text-primary">…</em>
            </p>
            <div class="progress my-2" style="height: 5px">
                <div id="progress" class="progress-bar" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:start()">Click here to run</a></p>

        </div>
    </main>

    <script>

        // TODO: Comapre output with currently published JSON
        // TODO: Optimization: dont wait on WP export to start on nodes

        // Configure data sources
        var config = {
            'wp': 'https://ml-fd.caf-fac.ca/wp-content/themes/canada/migrate.php',
            'aem_en': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-en.json',
            'aem_fr': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-fr.json',
            'map_en': 'https://www.canada.ca/en/department-national-defence/maple-leaf.sitemap.xml',
            'map_fr': 'https://www.canada.ca/fr/ministere-defense-nationale/feuille-derable.sitemap.xml'
        }

        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') { $progress.width(percent + '%') }
        }

        // Display last published
        $.get({
            url: 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-en.json/_jcr_content.json',
            success: function (obj) {
                $('#modified').text($.timeago(new Date(obj['jcr:lastModified']))).attr('title', obj['jcr:lastModified'])
                $('#modifiedby').text(obj['jcr:lastModifiedBy'])
            },
            error: function (e) { $updated.text('Error') }
        })

        // Generate an AJAX task to be completed
        function get(url, progress) {
            return function (cb) {
                $.get({
                    url: url,
                    success: function (res) {
                        if (progress) {
                            status(null, progress)
                        }
                        cb(null, res)
                    },
                    error: function (e) { cb(e, null) }
                })
            }
        }

        // Determine the article category based on the URL
        function category(url) {
            switch (/(\w+)\/\d{4}\/\d{2}\/[^/]+$/.exec(url).pop()) {
                case 'navy':
                case 'marine':
                    return 'rcn'
                case 'army':
                case 'armee':
                    return 'ca'
                case 'rcaf':
                case 'arc':
                    return 'rcaf'
            }
            return 'ml'
        }

        function start() {

            // Perform functions in sequence
            async.waterfall([

                function (cb) {
                    status('Downloading WordPress export and AEM sitemaps', 1)
                    async.parallel([
                        get(config.wp),
                        async.parallel([
                            get(config.map_en),
                            get(config.map_fr)
                        ], function (err, files) {
                            status('Converting XML sitemaps to JSON')
                            files = files.map(function (xml) {
                                return $(xml).find('loc').map(function () {
                                    return this.innerHTML
                                }).get()
                            })
                            cb(err, files)
                        })
                    ], function (err, res) {
                        cb(err, res[0], [res[1], res[2]])
                    })
                },

                function (data, xml, cb) {
                    status('Processing WordPress export', 3)
                    for (var lang in data) {
                        data[lang].forEach(function (o, i) {
                            data[lang][i][4] = data[lang][i][4].replace(/,\s/g, ',')
                        })
                    }

                    status('Processing AEM sitemaps')
                    var nodes = jQuery(xml).find('loc').map(function () {
                        return this.innerHTML
                    }).get().filter(function (url) {
                        return /\/\d{4}\/\d{2}\/[^/]+$/i.test(url)
                    })

                    cb(null, data, nodes)
                },

                function (data, nodes, cb) {
                    status('Downloading metadata (' + nodes.length + ' nodes)')

                    var tasks = {}
                    var percent = 5
                    var increment = 95 / nodes.length

                    nodes.forEach(function (url) {
                        percent += increment
                        tasks[url] = get(url.replace('.html', '/_jcr_content.json'), percent)
                    })

                    async.parallelLimit(tasks, 5, function (err, meta) {
                        cb(err, data, meta)
                    })
                },

                function (data, meta, cb) {
                    status('Processing metadata', 99)

                    Object.keys(meta).forEach(function (url) {
                        var o = meta[url]
                        var date = new Date(o['gcModifiedOverride'] || o['gcIssued'] || o['gcLastPublished']).toISOString()

                        data[o['jcr:language']].push([
                            category(url),
                            o['gcOGImage'] ? utf8.encode(o['gcOGImage']) : '',
                            '<a href="' + url.replace('https://www.canada.ca/', '/') + '">' + utf8.encode(o['jcr:title'].trim()) + '</a>',
                            o['gcDescription'] ? utf8.encode(o['gcDescription'].trim()) : '',
                            o['gcKeywords'] ? utf8.encode(o['gcKeywords'].trim() || '').replace(/,\s/g, ',') : '',
                            date.replace('.000Z', '')
                        ])
                    })

                    cb(null, data)
                },

                /*function (data, cb) {
                    status('Compare with current data')
                    async.parallel([
                        get(config.aem_en),
                        get(config.aem_fr)
                    ], function (err, res) {

                        var en1 = JSON.stringify(res[0])
                        var en2 = JSON.stringify(data.en)

                        var fr1 = JSON.stringify(res[1])
                        var fr2 = JSON.stringify(data.fr)

                        if (en1 !== en2 && fr1 !== fr2) {
                            status('No changes since previous publish', 100)
                            cb(1)
                        } else {
                            cb(null, data)
                        }


                    })

                }*/

            ], function (err, data) {
                if (err) {
                    console.log(err)
                } else {
                    status('Done (' + data.en.length + ' entries)', 100)

                    for (var lang in data) {
                        download(JSON.stringify({ data: data[lang] }, null, null), 'maple-' + lang + '.json', 'text/plain;charset=UTF-8;')
                    }
                }
            })
        }

    </script>

</body>

</html>