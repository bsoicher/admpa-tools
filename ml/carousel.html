<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="author" content="Ben Soicher">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Maple Leaf &gt; Carousel</title>

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>

    <style>
        .table>tbody>tr>td:last-child {
            vertical-align: middle;
        }

        img {
            width: 150px
        }

        textarea.border-0{
            height:100px;
            resize: none;
           
        }
    </style>
</head>

<body id="body">

    <div class="container">
        <h1 class="h4 mt-5">
            <a href="../index.html">ADMPA Web Tools</a>
            <small class="text-muted">&gt; Maple Leaf &gt; Carousel</small>
        </h1>
        <p>Use this page to generate the HTML of an image gallery.</p>
        <p>Images must first be published to canada.ca DAM in the folder (
            <code>dam/dnd-mdn/images/maple-leaf/articles/</code> )</p>


        <div class="mt-4">

            <h2 class="h6">Usage</h2>
            <ul>
                <li>Drag rows up or down to re-order images</li>
                <li>Removed a row by clicking the X on right side of the row</li>
            </ul>
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th width="150px">Image</th>
                    <th>English</th>
                    <th>French</th>
                    <th width="5px">&nbsp;</th>
                </tr>
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>

        <button id="add" type="button" class="btn btn-primary">Add Row</button>
        <button id="save" type="button" class="btn btn-primary float-right">Generate HTML</button>


        <div class="card-group mt-4 mb-4">
            <div class="card">

                <div class="card-header bg-transparent">
                    English
                    <button class="btn btn-link float-right py-0 aem-edit" data-config="en">Open in AEM</button>
                    <button class="btn btn-link float-right py-0" data-clipboard-action="copy" data-clipboard-target="#code_en">Copy</button>
                </div>
                <div class="card-body p-0">
                    <textarea id="code_en" class="form-control rounded-0 border-0" rows="4" readonly>ase few </textarea>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-transparent">
                    French
                    <button class="btn btn-link float-right py-0 aem-edit" data-config="fr">Open in AEM</button>
                    <button class="btn btn-link float-right py-0" data-clipboard-action="copy" data-clipboard-target="#code_fr">Copy</button>
                </div>
                <div class="card-body p-0">
                    <pre id="code_fr" class="form-control rounded-0 border-0">ase few </textarea>
                </div>
            </div>
        </div>

    </div>

    <script>

        // Configure data sources
        var config = {
            'en': 'https://www.canada.ca/en/department-national-defence/maple-leaf/03-08-women.html',
            'fr': 'https://www.canada.ca/fr/ministere-defense-nationale/feuille-derable/03-08-femmes.html'
        }

        // Extract carousel data from document
        function extract(html) {
            return $(html).find('.content-slider li').map(function () {
                var e = $(this)
                return {
                    'src': e.find('img').attr('src'),
                    'title': $.trim(e.find('.quote').text())
                }
            }).get()
        }

        // Load existing carousel content
        $.when(
            $.get({ url: config.en, cache: false }),
            $.get({ url: config.fr, cache: false })
        ).done(function (en, fr) {
            en = extract(en[0])
            fr = extract(fr[0])

            if (en.length != fr.length) console.log('Carousels dont match')

            for (var x = 0; x < en.length; x++) {
                add_row(en[x].src, en[x].title, fr[x].title)
            }

        }).fail(function () {
            console.log('Failed to load')
        })

        // Add a row to the table
        function add_row(url, en, fr) {
            $('#tbody').append('<tr><td class="align-middle"><img class="border" src="' + url + '"/></td><td><textarea class="form-control" rows="3">' + en + '</textarea></td><td><textarea class="form-control" rows="3">' + fr + '</textarea></td><td><button type="button" class="close align-middle" aria-label="Close" title="Remove"><span aria-hidden="true">&times;</span></button></td></tr>')
        }


        $(document).on('click', 'button.aem-edit', function () {
            
            console.log(123)
            
            var id = $(this).data('config')


            console.log(id)
            window.open( 'https://author-canada-prod.adobecqms.net/editor.html/content/canadasite/' + config[id].substr(22), '_blank'); 
        })

      



        var clip = new ClipboardJS('.btn');

        var baseURL = 'https://www.canada.ca/content/dam/dnd-mdn/images/maple-leaf/articles/'

        // Enable dragging to reorder table rows
        $('#tbody').sortable()

        // Add blank row
        $('#add').click(function () {
            $('#tbody').append(row)
        })

        // Handle remove row event
        $(document).on('click', 'button.close', function () {
            $(this).parent().parent().remove()
        })

        // Clear field validation if changed
        $(document).on('paste blur change keyup input', 'textarea', function () {
            $(this).removeClass('is-valid is-invalid')
        })


        // Validate a text field
        function validate_text() {
            var i = $(this)

            // Remove whitespace
            i.val($.trim(i.val()))

            // Make sure there is content
            if (i.val().length > 3) {
                i.removeClass('is-invalid').addClass('is-valid')
            } else {
                i.removeClass('is-valid').addClass('is-invalid')
            }
        }

        function generate() {
            var html = "<section class=\"wb-lbx lbx-gal\">\n\t<h4>Image gallery</h4>\n\t<ul class=\"list-inline\">"

            $('#tbody tr').each(function () {
                var e = $(this)

                var img = baseURL + (e.find('.url').val() || "")
                var alt = $('<span>' + e.find('.alt').val() + '</span>').text().replace(/"/g, '&quot;')
                var desc = $('<span>' + e.find('.desc').val() + '</span>').text().replace(/"/g, '&quot;')

                html += "\n\t\t<li>\n\t\t\t<a href=\"" + img + "\" title=\"" + desc + "\">"
                html += "\n\t\t\t\t<img src=\"" + img + "\" alt=\"" + alt + "\" class=\"img-responsive thumbnail\">\n\t\t\t</a>\n\t\t</li>"
            })

            return html + "\n\t</ul>\n</section>"
        }




        $('#save').click(function () {
            $('.desc,.alt').each(validate_text)
            $('.url').each(validate_image)
            $('#code').text(generate)
        })


    </script>

</body>

</html>