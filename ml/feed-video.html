<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Video feed</title>

    <!-- Speed optimization -->
    <link rel="dns-prefetch" href="https://www.canada.ca">

    <!-- Meta -->
    <meta charset="utf-8" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item"><a href="../index.html">Maple Leaf</a></li>
                    <li class="breadcrumb-item" aria-current="page">Video Feed &nbsp;<span class="badge badge-warning badge-pill">In Development</span></li>
                </ol>
            </nav>
            <p>Compiles a listing of corporate video metadata used in the search table.</p>
            <h2 class="h5">Instructions</h2>
            <ol class="pl-3">
                <li>Run the tool below. Two JSON files will be generated and downloaded</li>
            </ol>
            <p class="mt-4 mb-0">Status: Published <abbr id="modified" class="text-primary">…</abbr> by <span id="modifiedby" class="text-primary">…</span></p>
            <div class="progress my-2" style="height: 5px">
                <div id="progress" class="progress-bar" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:start()">Click here to start</a></p>
        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            'aem_en': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/canada-video.json',
            'map_en': 'https://www.canada.ca/en/department-national-defence/corporate/video.sitemap.xml',
            'map_fr': 'https://www.canada.ca/fr/ministere-defense-nationale/organisation/video.sitemap.xml'
        }

        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') { $progress.width(percent + '%') }
        }

        // Display last published
        $.get({
            url: config.aem_en + '/_jcr_content.json',
            success: function (obj) {
                $('#modified').text($.timeago(new Date(obj['jcr:lastModified']))).attr('title', obj['jcr:lastModified'])
                $('#modifiedby').text(obj['jcr:lastModifiedBy'])
            },
            error: function (e) { $updated.text('Error') }
        })

        // Define response fields
        var fields = [

            // Thumbnail image URL
            function (jcr) {
                if (!jcr['gcOGImage']) { return '' }
                return utf8.encode($.trim(jcr['gcOGImage']))
            },

            // Title (containing link)
            function (jcr) {
                if (!jcr['_self'] || !jcr['jcr:title']) { return '' }
                return '<a href="' + jcr._self.replace('https://www.canada.ca/', '/') + '">' + utf8.encode($.trim(jcr['jcr:title'])) + '</a>'
            },

            // Description
            function (jcr) {
                if (!jcr['gcDescription']) { return '' }
                return utf8.encode($.trim(jcr['gcDescription'].replace(/[\r\n]+/gm, ' ')).replace(/\.$/, ''))
            },

            // Tags
            function (jcr) {
                if (!jcr['gcKeywords']) { return '' }
                return utf8.encode(jcr['gcKeywords'].split(',').map(function (tag) {
                    return tag.trim()
                }).filter(function (tag) {
                    return tag ? tag : false
                }).join(','))
            },

            // Date
            function (jcr) {
                if (!jcr['gcModifiedOverride'] && !jcr['gcIssued'] && !jcr['gcLastPublished']) { return '' }
                return new Date(jcr['gcModifiedOverride'] || jcr['gcIssued'] || jcr['gcLastPublished']).toISOString().replace('.000Z', '')
            }
        ]

        // Generate an AJAX task to be completed
        function get(url, progress) {
            return function (cb) {
                $.get({
                    url: url,
                    success: function (data) {
                        if (progress) { status(null, progress) }
                        if (url.endsWith('.json')) { data._self = url.replace('/_jcr_content.json', '.html') }
                        cb(null, data)
                    },
                    error: function (xhr, status, err) { cb(err) }
                })
            }
        }

        function start() {

            status('Downloading AEM Sitemaps')

            // For time tracking
            var start = new Date().getTime()

            async.parallel([
                get(config.map_en),
                get(config.map_fr)
            ], function (err, sitemaps) {
                status('Processing sitemaps', 2)

                nodes = $(sitemaps).find('loc').map(function () {
                    // Extract URLs
                    return this.innerHTML
                }).get().filter(function (url) {
                    // Remove non article nodes
                    return true // /\/\d{4}\/\d{2}\/[^/]+$/i.test(url)
                })

                var percent = 3
                var increment = 96 / nodes.length

                nodes = nodes.map(function (url) {
                    // Create download tasks
                    return get(url.replace('.html', '/_jcr_content.json'), percent += increment)
                })

                status('Downloading metadata (' + nodes.length + ' nodes)', 3)
                async.parallelLimit(nodes, 5, function (err, meta) {
                    var data = { 'en': [], 'fr': [] }

                    // Generate data using field definitions
                    meta.forEach(function (jcr) {
                        if(jcr['cq:template'] === '/apps/canada/templates/page-pseudo-page') { return }

                        data[jcr['jcr:language']].push(fields.map(function (fn) { 
                            return fn(jcr)
                        }))
                    })
              
                    if (err) { return status('Error', 99, true) }

                    var elapsed = Math.round((new Date().getTime() - start) / 100) / 10
                    status('Done (' + data.en.length + ' entries in ' + elapsed + ' seconds)', 100)

                    download(JSON.stringify({ data: data.en }, null, null), 'video-en.json', 'text/plain;charset=UTF-8;')
                    download(JSON.stringify({ data: data.fr }, null, null), 'video-fr.json', 'text/plain;charset=UTF-8;')
                })
            })

        }

    </script>

</body>

</html>