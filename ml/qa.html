<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Quality Assurance</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>

</head>

<body id="body">
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5">
                <a href="../index.html">ADMPA Web Tools</a>
                <small class="text-muted">&gt; Maple Leaf &gt; Quality Assurance</small>
            </h1>
            <p>Analyze Maple Leaf articles (AEM only) for potential QA issues. This may take a while to run.</p>


            <div class="progress mt-4" style="height: 5px;">
                <div class="progress-bar" style="width:0%" id="progress"></div>
            </div>
            <p id="data-status">Click Run to begin</p>


            <button id="start" class="btn btn-primary" onclick="start()">Run</button>

            <!-- Table of issues -->

            <table id="issues" class="table my-5">
                <thead>
                    <tr>
                        <th class="border-top-0" width="200px">File</th>
                        <th class="border-top-0">Description</th>
                    </tr>
                </thead>
                <tbody class="border"></tbody>
            </table>

        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            'en': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-en.json',
            'fr': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-fr.json',
        }

        var data = {}

        // Always load unchached content
        $.ajaxSetup({ cache: false })

        function status(message, increment) {
            $('#data-status').text(message)

            var e = $('#progress')
            var start = parseInt(e.css('width'))
            var total = parseInt(e.parent().css('width'))

            var percent = start / total

           console.log(percent)

            $('#progress').css('width', (percent + increment) + '%')
        }

        setInterval(function(){
            status('test', 0.5)
        }, 500)



        // Generate an AJAX task to be completed
        function get(url) {
            return function (cb) {
                $.get({
                    url: url,
                    success: function (res) {
                        cb(null, res)
                    },
                    error: function (e) { cb(e, null) }
                })
            }
        }

        function start() {

            async.waterfall([

                function (cb) {
                    status('Downloading sitemaps', 0)
                    async.parallel([
                        get('https://www.canada.ca/en/department-national-defence/maple-leaf.sitemap.xml'),
                        get('https://www.canada.ca/fr/ministere-defense-nationale/feuille-derable.sitemap.xml')
                    ], function (err, files) {
                        status('Converting XML sitemaps to JSON')
                        files = files.map(function (xml) {
                            return $(xml).find('loc').map(function () {
                                return this.innerHTML
                            }).get()
                        })
                        cb(err, files)
                    })
                },

                function (data, cb) {
                    status('Processing sitemaps', .5)
                    data = data.map(function (arr) {
                        return arr.filter(function (url) {
                            return /\/\d{4}\/\d{2}\/[^/]+$/i.test(url)
                        })
                    })
                    cb(null, data)
                },

                function(data,cb) {
                    status('Downloading HTML')

                    data = data.map(function(arr) {
                        arr.map(function(url){
                            return get(url)
                        })
                    })

                    var tasks = {}

                    data[0].forEach(function (url) {
                        tasks[url] = get(url)
                    })

                   // data[0].forEach(function (url) {
                   //     tasks[url] = get(url.replace('.html', '/_jcr_content.json'))
                  //  })

                    async.parallelLimit(tasks, 5, function (err, meta) {
                        cb(err, data, meta)
                    })

                }


            ], function (err, data, meta) {
                console.log(data)
                console.log(meta)
            })


        }





        function log(file, message, type) {
            $('#issues tbody').append('<tr' + (type ? ' class="table-' + type + '"' : '') + '><td>' + file + '</td><td>' + message + '</td></tr>')
        }




    </script>

</body>

</html>