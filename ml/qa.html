<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Quality Assurance</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>

</head>

<body id="body">
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5">
                <a href="../index.html">ADMPA Web Tools</a>
                <small class="text-muted">&gt; Maple Leaf &gt; Quality Assurance</small>
            </h1>
            <p>Analyze Maple Leaf articles (AEM only) for potential QA issues. This may take a while to run.</p>


            <div class="progress mt-4" style="height: 5px;">
                <div class="progress-bar" style="width:0%" id="progress"></div>
            </div>
            <p id="data-status">Click Run to begin</p>


            <button id="start" class="btn btn-primary" onclick="start()">Run</button>

            <!-- Table of issues -->

            <table id="issues" class="table my-5">
                <thead>
                    <tr>
                        <th class="border-top-0" width="200px">File</th>
                        <th class="border-top-0">Description</th>
                    </tr>
                </thead>
                <tbody class="border"></tbody>
            </table>

        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            'en': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-en.json',
            'fr': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-fr.json',
        }

        var data = {}

        // Always load unchached content
        $.ajaxSetup({ cache: false })

        function status(message, percent) {
            $('#data-status').text(message)
            if (typeof percent !== 'undefined') {
                $('#progress').css('width', '+=' + percent + '%')
            }
        }

        console.log( $('#progress').css('width') )

        // Generate an AJAX task to be completed
        function get(url, increment) {
            return function (cb) {
                $.get({
                    url: url,
                    success: function (res) {
                        if (increment) {
                            $('#progress').css('width', '+=' + increment + '%')
                        }
                        cb(null, res)
                    },
                    error: function (e) { cb(e, null) }
                })
            }
        }


        function start() {

            async.waterfall([

                function (cb) {
                    status('Downloading sitemaps', 0)
                    async.parallel([
                        get('https://www.canada.ca/en/department-national-defence/maple-leaf.sitemap.xml', 5),
                        get('https://www.canada.ca/fr/ministere-defense-nationale/feuille-derable.sitemap.xml', 5)
                    ], function (err, files) {
                        status('Converting XML sitemaps to JSON')
                        files = files.map(function (xml) {
                            return $(xml).find('loc').map(function () {
                                return this.innerHTML
                            }).get()
                        })
                        cb(err, files)
                    })
                },

                function (data, cb) {
                    status('Processing sitemaps', .5)
                    data = data.map(function (arr) {
                        return arr.filter(function (url) {
                            return /\/\d{4}\/\d{2}\/[^/]+$/i.test(url)
                        })
                    })
                    cb(null, data)
                },




            ], function (err, data) {
                console.log(data)
            })


        }





        function log(file, message, type) {
            $('#issues tbody').append('<tr' + (type ? ' class="table-' + type + '"' : '') + '><td>' + file + '</td><td>' + message + '</td></tr>')
        }




    </script>

</body>

</html>