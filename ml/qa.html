<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Quality Assurance</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>

</head>

<body id="body">
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5">
                <a href="../index.html">ADMPA Web Tools</a>
                <small class="text-muted">&gt; Maple Leaf &gt; Quality Assurance Test</small>
                <span class="badge badge-warning">Under Development</span>
            </h1>

            <!-- Description 
            <p>Analyze Maple Leaf articles (AEM only) for potential QA issues. This may take a while to run.</p>

       
            <div class="progress my-2" style="height: 5px">
                <div id="progress" class="progress-bar" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:start()">Click here to run</a></p>

          
            <table id="issues" class="table my-5">
                <thead>
                    <tr>
                        <th class="border-top-0" width="200px">File</th>
                        <th class="border-top-0">Description</th>
                    </tr>
                </thead>
                <tbody class="border"></tbody>
            </table>
-->
        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            'en': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-en.json',
            'fr': 'https://www.canada.ca/content/dam/dnd-mdn/documents/json/maple-fr.json',
        }

        var data = {}

        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') { $progress.width(percent + '%') }
        }

        // Generate an AJAX task to be completed
        function get(url, progress) {
            return function (cb) {
                $.get({
                    url: url,
                    success: function (res) {
                        if (progress) {
                            status(null, progress)
                        }
                        cb(null, res)
                    },
                    error: function (e) { cb(e, null) }
                })
            }
        }

        function start() {

            async.waterfall([

                function (cb) {
                    status('Downloading sitemaps', 1)
                    async.parallel([
                        get('https://www.canada.ca/en/department-national-defence/maple-leaf.sitemap.xml'),
                        get('https://www.canada.ca/fr/ministere-defense-nationale/feuille-derable.sitemap.xml')
                    ], function (err, sitemaps) {
                        status('Processing sitemaps')

                        nodes = $(sitemaps).find('loc').map(function () {
                            // Extract URLs
                            return this.innerHTML
                        }).get().filter(function (url) {
                            // Remove non article nodes
                            return /\/\d{4}\/\d{2}\/[^/]+$/i.test(url)
                        })

                        var percent = 3
                        var increment = 96 / nodes.length

                        nodes = nodes.map(function (url) {
                            // Create download tasks
                            return get(url, percent += increment)
                        })

                        status('Loading documents (' + nodes.length + ' nodes)', 3)
                        async.parallelLimit(nodes, 5, function (err, html) {
                            cb(err, html)
                        })
                    })
                },

                function (html, cb) {
                    status('Processing documents')

                    console.log(html)
                    
                    cb(err, html)
                   
                    //cb(1)


                    // data[0].forEach(function (url) {
                    //     tasks[url] = get(url.replace('.html', '/_jcr_content.json'))
                    //  })

                    

                }

            ], function (err, data, meta) {
                console.log(data)
                console.log(meta)
            })


        }





        function log(file, message, type) {
            $('#issues tbody').append('<tr' + (type ? ' class="table-' + type + '"' : '') + '><td>' + file + '</td><td>' + message + '</td></tr>')
        }




    </script>

</body>

</html>