<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; QA Single</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>

</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5"><a href="../index.html">ADMPA Web Tools</a><small class="text-muted">&gt; Maple Leaf &gt; QA Single</small></h1>
            <p>Analyze an AEM article for common issues. If the article has a redirect in place on the WordPress site, it will be checked.</p>

            <!-- Input field -->
            <div class="input-group mt-4">
                <input id="url" type="text" class="form-control" />
                <div class="input-group-append">
                    <a class="btn btn-primary" href="javascript:start()">Start</a>
                </div>
            </div>
            <small class="form-text text-muted">Full URL of AEM article</small>

            <!-- Table of issues -->
            <table id="issues" class="table mb-5 mt-4">
                <tbody class="border"></tbody>
            </table>

        </div>
    </main>

    <script>

        // TODO, compare with french version (num tags, num images, date...)

        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $url = $('#url')
        var $tbody = $('#issues tbody')

        // Log messages
        function info(str) { $tbody.append('<tr class="table-info"><td>' + str + '</td></tr>') }
        function error(str) { $tbody.append('<tr class="table-danger"><td>' + str + '</td></tr>') }
        function warning(str) { $tbody.append('<tr class="table-warning"><td>' + str + '</td></tr>') }

        // Array of tests to run
        var tests = [

            // Evaluate tags
            function ($html, old) {

                try {
                    var tags = $html.find('meta[name=keywords]').attr('content').split(',')
                } catch (e) {
                    var tags = []
                }

                if (tags.length === 0) {
                    issue('danger', 'No keywords')
                }

            }
        ]

        function start() {

            // Get URL value
            var url = $url.val()

            // Clear issue table
            $tbody.empty()

            // Basic URL validation
            if (!url) { return error('URL input is empty') }
            if (!url.match(/^https:\/\/www\.canada\.ca\//i)) { return error('The URL must start with <strong>https://www.canada.ca/</strong>') }
            if (!url.match(/\.html$/i)) { return error('URL must have the <strong>.html</strong> file extension') }

            // Multiple same captions

            var wp = null

            // Try and load it
            $.get({
                url: url,
                error: function(xhr, status, err){ error('Download failed (Error: ' + err + ')') },
                success: function(data) {
                    info('Loaded html')

                    $doc = $(data)

                    var lang = $doc.find('html').attr('lang')
                    

                    $.get({
                        url: 'https://ml-fd.caf-fac.ca/wp-content/themes/canada/old_article.php?url=' + url,
                        error: function() { info('Article was not migrated from WordPress') },
                        success: function(){ info('Loaded original content from WordPress') }
                    })
                }
            })

        }

    </script>

</body>

</html>