<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; QA Single</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>
    <script src="https://unpkg.com/chai-string@1.5.0/chai-string.js"></script>

    <!--<script src="https://cdn.jsdelivr.net/npm/chai-jquery@2.1.0/chai-jquery.js"></script>-->

</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5"><a href="../index.html">ADMPA Web Tools</a><small class="text-muted">&gt; Maple Leaf &gt; QA Single</small></h1>
            <div class="alert alert-warning mt-3" role="alert">Warning: Still under development</div>
            <p>Analyze a Maple Leaf article for common issues.</p>

            <!-- Input field -->
            <div class="input-group mt-4">
                <input id="url" type="text" class="form-control" />
                <div class="input-group-append">
                    <a class="btn btn-primary" href="javascript:start()">Start</a>
                </div>
            </div>
            <small class="form-text text-muted">Full URL of AEM article</small>

            <!-- Show pass/ fail-->

            <!-- Table of issues -->
            <ul id="issues" class="list-group mb-5 mt-4"></ul>

        </div>
    </main>



    <script>





        // TODO, compare with french version (num tags, num images, date...)

        // Use chai assertion library
        var assert = chai.assert
        var expect = chai.expect


        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $url = $('#url')
        var $issues = $('#issues')

        if (window.location.search) {
            $url.val(window.location.search.replace(/^\?=/, ''))
            start()
        }

        // Log messages
        function log(str) { $issues.append('<li class="list-group-item">' + short(str) + '</li>') }
        function pass(str) { $issues.append('<li class="list-group-item text-success">' + short(str) + '</li>') }
        function fail(str) { $issues.append('<li class="list-group-item text-danger">' + short(str) + '</li>') }

        function short(str) {
            return str
            var i = str.indexOf(':')
            return i > 0 ? str.substr(0, i) : str
        }


       

        /**
         * Rewrite absolute links to include domains
         * @param {String} html Raw html response
         * @return {String} Modified html
         */
        function rewrite_links(html) {
            return html.replace(/src="/ig, ' src="https://canada.ca/')
        }

        // Load HTML, alt HTML (if available) and WordPress object (if available)


        // Need to download JCR version as well
        function load(url) {
            var d = $.Deferred()
            var jcr = url.replace('.html', '/_jcr_content.json')

           /* $.get(jcr).fail(function (xhr, status, err) {
                d.reject('Download failed (' + err + ')')
            }).done(function() {

            }*/

            $.get(url).fail(function (xhr, status, err) {
                d.reject('Download failed (' + err + ')')
            }).done(function (doc) {
                var $doc = $('<div>' + doc + '</div>')
                $.get('https://www.canada.ca' + $doc.find('#wb-lng a').attr('href')).always(function (alt) {
                    $alt = typeof alt === 'string' ? $('<div>' + alt + '</div>') : null

                   /* $([$doc, $alt]).find('img').attr('src', function (i, url) {
                        return url.charAt(0) === '/' ? 'https://www.canada.ca' + url : url
                    })*/

                    $.getJSON('https://ml-fd.caf-fac.ca/wp-content/themes/canada/old_article.php?url=' + url).fail(function () {
                        d.resolve($doc, $alt, null)
                    }).done(function (wp) {
                        d.resolve($doc, $alt, wp)
                    })
                })
            })

            return d
        }

        function start() {

            // Get URL value
            url = $url.val()

            // Clear issue table
            $issues.empty()

            try {

                // Basic URL validation
                assert(url, 'URL is required')
                assert(url.startsWith('https://www.canada.ca/'), 'Invalid URL: Must begin with "https://www.canada.ca/"')
                assert(url.endsWith('.html'), 'Invalid URL: File extension must be ".html"')

                log('Loading...')

                // Execute each test
                load(url).done(function ($doc, $alt, wp) {
                    $issues.empty()

                    tests.forEach(function (test) {
                        try {
                            var res = test($doc, $alt, wp)
                            if (res) {
                                pass(res)
                            }
                        } catch (e) {
                            fail(e.message)
                        }

                    })
                }).fail(function (err) {
                    error(err)
                })

            } catch (e) {
                console.log(e.message)
                fail(e.message)
            }


        }

        // List of tests to run
        var tests = [



            // What data was downloaded?
            function ($doc, $alt, wp) {

                function check(val) {
                    return '<strong class="text-' + (val ? 'success">✓' : 'danger">✕') + '</strong>'
                }

                log('Download(s) complete ( HTML ' + check($doc) + ', alternate HTML ' + check($alt) + ', WordPress ' + check(wp) + ' )')
            },


            function ($doc, $alt) {
                var thumb1 = $doc.find('meta[property="og:image"]').attr('content')
                var thumb2 = $alt.find('meta[property="og:image"]').attr('content')

                expect(thumb1, 'Thumbnail image (open graph image) not set', null, null, null, false).to.exist
                expect(thumb1).to.not.include('/_jcr_content/', 'Thumbnail image should not be variation of original')
                expect(thumb1).to.equal(thumb2, 'Thumbnail image not consistent between languages', null, null, null, false)

                pass('Passed thumbnail tests')
            },

            function ($doc) {

                var links = $doc.find('a[href*=".mil.ca"')

                expect(links.length).to.equal(0, 'Intranet links found')

                return 'No Intranet links found'
            },

            // Wordpress links
            function ($doc) {
                var links = $doc.find('a[href*="caf-fac.ca"]')

                expect(links.length).to.equal(0, 'Links to caf-fac.ca found')

                return 'No links to "caf-fac.ca" found'
            },

            // Same number of tags?
            function ($doc, $alt, wp) {
                var tags1 = $doc.find('meta[name="keywords"]').attr('content')
                var tags2 = $alt.find('meta[name="keywords"]').attr('content')

                function taglist(tags) {
                    return tags.split(',').map(function (tag) {
                        return tag.trim()
                    }).filter(function (tag) {
                        return tag ? !tag.match(/(featured|vedette)$/i) : false
                    })
                }

                

                expect(tags1, '').to.exist
                expect(tags1.length).is.at.least(1, '')
            },

            // Consistent Dates
            function ($doc, $alt, wp) {
                var a = $doc.find('#wb-dtmd time').text()
                var b = $alt ? $alt.find('#wb-dtmd time').text() : null

                if (a && b) {
                    a.should.equal(b)
                }


                // assert.equal(a, c, 'nooo why fail??')//.and.to.equal(c, 'ahhhh');

                //assert.fail( a == b == c, 'Not all dates match')


                if (!b && !c) { return log('Modified Date: Nothing to compare values with') }
                if (!c && a === b) { return pass('Modified Date: Consistent between languages') }
                if (!c && a !== b) { return fail('Modified Date: Inconsistent ( ' + a + ' and ' + b + ' )') }
                if (a === b && a !== c) { return fail('Modified Date: Consistent between languages, but not with WordPress') }
                if (a === b && a === c) { return pass('Modified Date: Consistent between languages and WordPress') }
            },



        ]

    </script>

</body>

</html>