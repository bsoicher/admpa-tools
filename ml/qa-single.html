<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; QA Single</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>

    <!--<script src="https://unpkg.com/chai-string@1.5.0/chai-string.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chai-jquery@2.1.0/chai-jquery.js"></script>-->

</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5"><a href="../index.html">ADMPA Web Tools</a><small class="text-muted">&gt; Maple Leaf &gt; QA Single</small></h1>
            <div class="alert alert-warning mt-3" role="alert">Warning: Still under development</div>
            <p>Analyze a Maple Leaf article for common issues.</p>

            <!-- Input field -->
            <div class="input-group mt-4">
                <input id="url" type="text" class="form-control" />
                <div class="input-group-append">
                    <a class="btn btn-primary" href="javascript:start()">Start</a>
                </div>
            </div>
            <small class="form-text text-muted">Full URL of AEM article</small>

            <!-- Show pass/ fail-->

            <!-- Table of issues -->
            <ul id="issues" class="list-group mb-5 mt-4"></ul>

        </div>
    </main>



    <script>





        // TODO, compare with french version (num tags, num images, date...)

        // Use chai assertion library
        var assert = chai.assert
        var expect = chai.expect


        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $url = $('#url')
        var $issues = $('#issues')

        if (window.location.search) {
            $url.val(window.location.search.replace(/^\?=/, ''))
            start()
        }

        // Log messages
        function log(str) { $issues.append('<li class="list-group-item">' + str + '</li>') }
        function pass(str) { $issues.append('<li class="list-group-item text-success">' + str + '</li>') }


        /**
         * Get metadata of an AEM node
         * @param {String} url AEM document URL
         * @return {Promise.<Object, null>} WordPress article object
         */
        function load_jcr(url) {
            var d = $.Deferred()

            $.get({
                url: url.replace('.html', '/_jcr_content.json'),
                success: function (jcr) { d.resolve(jcr) },
                error: function () { d.resolve(null) }
            })

            return d.promise()
        }

        /**
         * Get WordPress version of AEM page if it exists
         * @param {String} url AEM document URL
         * @return {Promise.<Object, null>} WordPress article object
         */
        function load_wp(url) {
            var d = $.Deferred()

            $.get({
                url: 'https://ml-fd.caf-fac.ca/wp-content/themes/canada/old_article.php?url=' + url,
                success: function (jcr) { d.resolve(jcr) },
                error: function () { d.resolve(null) }
            })

            return d.promise()
        }

        /**
         * Get HTML document of AEM page
         * @param {String} url AEM document URL
         * @return {Promise.<jQuery, null>} jQuery processed AEM article document 
         */
        function load_page(url) {
            var d = $.Deferred()

            $.get({
                url: url.replace('/content/canadasite/', 'https://www.canada.ca/'),
                dataFilter: function (data) { return data.replace(/src="/ig, ' src="https://www.canada.ca/') },
                success: function (html) { d.resolve($('<div>' + html + '</div>')) },
                error: function () { d.resolve(null) }
            })

            return d.promise()
        }

        /**
         * Download all the relevant data in parallel
         * @param {String} url AEM document URL
         * @return {Promise.<Object>} contains all the data sources
         */
        function load(url) {
            var d = $.Deferred()

            $.get({
                url: url.replace('.html', '/_jcr_content.json'),
                success: function (jcr) {
                    $.when(
                        load_page(url),
                        load_page(jcr.gcAltLanguagePeer),
                        load_wp(url)
                    ).done(function ($doc, $alt, wp) {
                        d.resolve({ jcr: jcr, $doc: $doc, $alt: $alt, wp: wp })
                    })
                },
                error: function (xhr, status, err) { d.reject('Download failed (' + err + ')') }
            })

            return d.promise()
        }

        function start() {

            // Get URL value
            url = $url.val()

            // Clear issue table
            $issues.empty()

            try {

                // Basic URL validation
                assert(url, 'URL is required')
                assert(url.startsWith('https://www.canada.ca/'), 'Invalid URL: Expected to start with "https://www.canada.ca/"')
                assert(url.endsWith('.html'), 'Invalid URL: Expected to end with ".html"')

                log('Loading...')

                // Execute each test
                load(url).done(function (data) {
                    $issues.empty()

                    tests.forEach(function (test) {
                        try {
                            var res = test(data)
                            if (res) {
                                pass(res)
                            }
                        } catch (e) {
                            log(e.message)
                        }

                    })
                }).fail(function (err) {
                    log(err)
                })

            } catch (e) {
                console.log(e.message)
                log(e.message)
            }


        }

        // List of tests to run
        var tests = [



            // What data was downloaded?
            function (data) {

                function check(val) {
                    return '<strong class="text-' + (val ? 'success">✓' : 'danger">✕') + '</strong>'
                }

                log('Download(s) complete ( HTML ' + check(data.$doc) + ', alternate HTML ' + check(data.$alt) + ', WordPress ' + check(data.wp) + ' )')

                log('Node created by: ' + data.jcr['gcCredentialFirstname'] + ' ' + data.jcr['gcCredentialLastname'])
            },

            

            function (data) {
                assert(data.jcr['gcModifiedIsOverridden'], 'Metadata: Date modified override is not enabled')
                assert(data.jcr['gcModifiedOverride'], 'Metadata: Date modified override is not set')

                

                pass('Metadata: Date modified override is present')
            },


            function (data) {
                var thumb1 = data.$doc.find('meta[property="og:image"]').attr('content')
                var thumb2 = data.$alt.find('meta[property="og:image"]').attr('content')

                expect(thumb1, 'Thumbnail image (open graph image) not set').to.exist
                expect(thumb1).to.not.include('/_jcr_content/', 'Thumbnail image should not be variation of original')
                expect(thumb1).to.equal(thumb2, 'Thumbnail image not consistent between languages')

                pass('Passed thumbnail tests')
            },

            // Intranet links
            function (data) {
                var links = data.$doc.find('a[href*=".mil.ca"')
                assert(links.length === 0, links.length + ' intranet links found')
                pass('No Intranet links found')
            },

            // Wordpress links
            function (data) {
                var links = data.$doc.find('a[href*="caf-fac.ca"]')
                assert(links.length === 0, links.length + ' links to caf-fac.ca found')
                pass('No links to "caf-fac.ca" found')
            },

            // Same number of tags?
            function (data) {
                var tags1 = data.$doc.find('meta[name="keywords"]').attr('content')
                var tags2 = data.$alt.find('meta[name="keywords"]').attr('content')

                function taglist(tags) {
                    return tags.split(',').map(function (tag) {
                        return tag.trim()
                    }).filter(function (tag) {
                        return tag ? !tag.match(/(featured|vedette)$/i) : false
                    })
                }



                expect(tags1, '').to.exist
                expect(tags1.length).is.at.least(1, '')
            },

            // Consistent Dates
            function (data) {
                var a = data.$doc.find('#wb-dtmd time').text()
                var b = data.$alt ? data.$alt.find('#wb-dtmd time').text() : null

                if (a && b) {
                    a.should.equal(b)
                }


                // assert.equal(a, c, 'nooo why fail??')//.and.to.equal(c, 'ahhhh');

                //assert.fail( a == b == c, 'Not all dates match')


                if (!b && !c) { return log('Modified Date: Nothing to compare values with') }
                //if (!c && a === b) { return pass('Modified Date: Consistent between languages') }
                //if (!c && a !== b) { return fail('Modified Date: Inconsistent ( ' + a + ' and ' + b + ' )') }
                //if (a === b && a !== c) { return fail('Modified Date: Consistent between languages, but not with WordPress') }
                //if (a === b && a === c) { return pass('Modified Date: Consistent between languages and WordPress') }
            },



        ]

    </script>

</body>

</html>