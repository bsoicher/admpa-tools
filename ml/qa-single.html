<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; QA Single</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>

    <!--<script src="https://unpkg.com/chai-string@1.5.0/chai-string.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chai-jquery@2.1.0/chai-jquery.js"></script>-->

</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5"><a href="../index.html">ADMPA Web Tools</a><small class="text-muted">&gt; Maple Leaf &gt; QA Single</small></h1>
            <div class="alert alert-warning mt-3" role="alert">Warning: Still under development</div>
            <p>Analyze a Maple Leaf article for common issues.</p>

            <!-- Input field -->
            <div class="input-group mt-4">
                <input id="url" type="text" class="form-control" />
                <div class="input-group-append">
                    <a class="btn btn-primary" href="javascript:start()">Start</a>
                </div>
            </div>
            <small class="form-text text-muted">Full URL of AEM article</small>

            <!-- Show pass/ fail-->

            <!-- Table of issues -->
            <ul id="issues" class="list-group mb-5 mt-4 "></ul>

        </div>
    </main>



    <script>





        // TODO, compare with french version (num tags, num images, date...)

        // Use chai assertion library
        var assert = chai.assert
        var expect = chai.expect


        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $url = $('#url')
        var $issues = $('#issues')

        if (window.location.search) {
            $url.val(window.location.search.replace(/^\?=/, ''))
            start()
        }

        // Log messages
        function log(str) { $issues.append('<li class="list-group-item">' + str + '</li>') }
        function pass(str) { $issues.append('<li class="list-group-item text-success"><strong class="mr-3">✓</strong>' + str + '</li>') }
        function fail(str) { $issues.append('<li class="list-group-item text-danger"><strong class="mr-3">✕</strong>' + str + '</li>') }

        /**
         * Get metadata of an AEM node
         * @param {String} url AEM document URL
         * @return {Promise.<Object, null>} WordPress article object
         */
        function load_jcr(url) {
            var d = $.Deferred()

            $.get({
                url: url.replace('/content/canadasite/', 'https://www.canada.ca/').replace('.html', '/_jcr_content.json'),
                success: function (jcr) { d.resolve(jcr) },
                error: function (xhr, status, err) { d.reject(err) }
            })

            return d.promise()
        }

        /**
         * Get WordPress version of AEM page if it exists
         * @param {String} url AEM document URL
         * @return {Promise.<Object, null>} WordPress article object
         */
        function load_wp(url) {
            var d = $.Deferred()

            $.get({
                url: 'https://ml-fd.caf-fac.ca/wp-content/themes/canada/old_article.php?url=' + url,
                success: function (jcr) { d.resolve(jcr) },
                error: function () { d.resolve(null) }
            })

            return d.promise()
        }

        /**
         * Get HTML document of AEM page
         * @param {String} url AEM document URL
         * @return {Promise.<jQuery, null>} jQuery processed AEM article document 
         */
        function load_page(url) {
            var d = $.Deferred()

            $.get({
                url: url.replace('/content/canadasite/', 'https://www.canada.ca/'),
                dataFilter: function (data) { return data.replace(/src="/ig, ' src="https://www.canada.ca/') },
                success: function (html) { d.resolve($('<div>' + html + '</div>')) },
                error: function () { d.resolve(null) }
            })

            return d.promise()
        }

        /**
         * Download all the relevant data in parallel
         * @param {String} url AEM document URL
         * @return {Promise.<Object>} contains all the data sources
         */
        function load(url) {
            var d = $.Deferred()

            load_jcr(url).done(function (jcr) {
                $.when(
                    load_wp(url),
                    load_jcr(jcr.gcAltLanguagePeer),
                    load_page(url)
                ).done(function (wp, jcr_alt, $doc) {
                    d.resolve({ jcr: jcr, $doc: $doc, jcr_alt: jcr_alt, wp: wp })
                })
            }).fail(function (e) {
                throw new Error('Unable to load')

            })

            return d.promise()
        }

        function start() {

            // Get URL value
            url = $url.val()

            // Clear issue table
            $issues.empty()

            try {

                // Basic URL validation
                assert(url, 'URL is required')
                assert(url.startsWith('https://www.canada.ca/'), 'Invalid URL: Expected to start with "https://www.canada.ca/"')
                assert(url.endsWith('.html'), 'Invalid URL: Expected to end with ".html"')

                log('Loading...')

                // Execute each test
                load(url).done(function (data) {
                    $issues.empty()

                    tests.forEach(function (test) {
                        try {
                            var res = test(data)
                            if (res) {
                                pass(res)
                            }
                        } catch (e) {
                            fail(e.message)
                        }

                    })
                })

            } catch (e) {
                $issues.empty()
                fail(e)
            }


        }

        // TODO USE CUSTOM ASSERT FUNCTION. NO NEED FOR CHAI. IT COULD TRACK TESTS..
        // TODO ALLOW GROUPING OF TESTS

        // List of tests to run
        var tests = [

            function (d) {
                var a = d.jcr['gcModifiedOverride']
                var b = d.jcr_alt['gcModifiedOverride']
                assert(d.jcr['gcModifiedIsOverridden'], 'Metadata: Date modified override is not enabled')
                assert(a, 'Metadata: Date modified override is not set')
                assert(a === b, 'Metadata: Date modified override does not match between languages')
                pass('Metadata: Date modified override passed tests')
            },

            function (d) {
                if (d.wp) {
                    var a = new Date(d.jcr['gcModifiedOverride'] || d.jcr['gcIssued'] || d.jcr['gcLastPublished']).toString('MMMM d, yyyy hh:mm tt')
                    var b = new Date(d.wp.date).toString('MMMM d, yyyy hh:mm tt')
                    assert(a === b, 'Metadata: Date does not match WordPress: ' + b)
                    pass('Metadata: Date was migrated properly')
                }
            },

            function (d) {
                var a = d.$doc.find('main p>strong:first')
                if (a.length) {
                    var m = a.text().match(/^[^\d]+(\d+)[^\d]+(\d+) -/)
                    if (m) {
                        var b = new Date(d.jcr['gcModifiedOverride'] || d.jcr['gcIssued'] || d.jcr['gcLastPublished']).toString('d yyyy')
                        assert(m[1] + ' ' + m[2] === b, 'Content: Byline date does not match article date')
                        pass('Content: Byline date is consistent with article date')
                    }
                }
            },

            function (d) {
                var a = d.jcr['gcOGImage']
                var b = d.jcr_alt['gcOGImage']
                assert(a, 'Metadata: Thumbnail image (open graph) not set')
                assert(!a.includes('/_jcr_content/'), 'Metadata: Thumbnail image (open graph) should not be coppied from within the article')
                assert(a === b, 'Metadata: Thumbnail image (open graph) does not match between languages')
                pass('Metadata: Thumbnail image passed tests')
            },

            /*function (d) {
                var a = d.$doc.find('img:not([alt])')
                assert(a.length === 0, 'Content: Images without caption')
                pass('Metadata: Thumbnail image passed tests')

            },*/

            function (d) {
                var a = d.$doc.find('a[href*=".mil.ca"').length
                assert(a === 0, 'Content: ' + a + ' intranet links found')
                pass('Content: Intranet links were not found')
            },

            function (d) {
                var a = d.$doc.find('a[href*="caf-fac.ca"]').length
                assert(a === 0, 'Content: ' + a + ' Links to caf-fac.ca found')
                pass('Content: Links to "caf-fac.ca" were not found')
            },

            function (d) {
                var a = d.jcr['gcKeywords']
                var b = d.jcr_alt['gcKeywords']

                assert(a, 'Metadata: Keywords (tags) not set')

                function taglist(tags) {
                    return tags.split(',').map(function (tag) {
                        return tag.trim()
                    }).filter(function (tag) {
                        return tag ? !tag.match(/(featured|vedette)$/i) : false
                    })
                }

                a = taglist(a)
                b = taglist(b)

                assert(a.length === b.length, 'Metadata: Keywords (tags), different number of tags between languages (' + a.length + ' vs ' + b.length + ')')

                pass('Metadata: Keywords (tags) passed 2 tests')
            },

        ]

    </script>

</body>

</html>