<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; QA Single</title>

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>



</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5"><a href="../index.html">ADMPA Web Tools</a><small class="text-muted">&gt; Maple Leaf &gt; QA Single</small></h1>
            <p>Analyze a Maple Leaf article for common issues.</p>

            <!-- Input field -->
            <div class="input-group mt-4">
                <input id="url" type="text" class="form-control" />
                <div class="input-group-append">
                    <a class="btn btn-primary" href="javascript:start()">Start</a>
                </div>
            </div>
            <small class="form-text text-muted">Full URL of AEM article</small>

            <!-- Show pass/ fail-->

            <!-- Table of issues -->
            <ul id="issues" class="list-group mb-5 mt-4"></ul>

        </div>
    </main>



    <script>


        // TODO, compare with french version (num tags, num images, date...)

        // Use chai assertion library
        var assert = chai.assert
        var expect = chai.expect

        // Prevent loading cached data
        $.ajaxSetup({ cache: false })

        // Preselect elements
        var $url = $('#url')
        var $issues = $('#issues')

        // Log messages
        function log(str) { $issues.append('<li class="list-group-item">' + str + '</li>') }
        function pass(str) { $issues.append('<li class="list-group-item text-success">' + str + '</li>') }
        function fail(str) { $issues.append('<li class="list-group-item text-danger">' + str + '</li>') }

        // Load HTML, alt HTML (if available) and WordPress object (if available)
        function load(url) {
            var d = $.Deferred()

            $.get(url).fail(function (xhr, status, err) {
                d.reject('Download failed (' + err + ')')
            }).done(function (doc) {
                var $doc = $('<div>' + doc + '</div>')
                $.get('https://www.canada.ca' + $doc.find('#wb-lng a').attr('href')).always(function (alt) {
                    $alt = typeof alt === 'string' ? $('<div>' + alt + '</div>') : null
                    $.getJSON('https://ml-fd.caf-fac.ca/wp-content/themes/canada/old_article.php?url=' + url).fail(function () {
                        d.resolve($doc, $alt, null)
                    }).done(function (wp) {
                        d.resolve($doc, $alt, wp)
                    })
                })
            })

            return d
        }

        function start() {


            // Get URL value
            var url = $url.val()

            // Clear issue table
            $issues.empty()

            try {

                // Basic URL validation
                expect(url, 'URL is required').to.not.be.empty
                expect(url).to.include('https://www.canada.ca/', 'Invalid URL')
                expect(url.split('.').pop()).to.equal('html', 'Invalid file extension')

                // Execute each test
                load(url).done(function ($doc, $alt, wp) {
                    tests.forEach(function (test) {
                        try {
                            var res = test($doc, $alt, wp)
                            if (res) {
                                pass(res)
                            }
                        } catch (e) {
                            fail(e.message)
                        }

                    })
                }).fail(function (err) {
                    error(err)
                })

            } catch (e) {
                fail(e.message)
            }


        }

        // List of tests to run
        var tests = [



            // What data was downloaded?
            function ($doc, $alt, wp) {

                function check(val) {
                    return '<strong class="text-' + (val ? 'success">✓' : 'danger">✕') + '</strong>'
                }

                log('Download(s) complete ( HTML ' + check($doc) + ', alternate HTML ' + check($alt) + ', WordPress ' + check(wp) + ' )')
            },


            function ($doc) {

                var year = Number($doc.find('#wb-dtmd time').text().substr(0, 4))

                expect(year, 'Only 2020 articles').is.equal(2020)

                return 'Documents are all 2020'
            },

            // Same number of tags?
            function ($doc, $alt, wp) {

                function tagCount(tags) {
                    return tags.split(',').map(function (tag) {
                        return tag.trim()
                    }).filter(function (tag) {
                        return tag ? !tag.match(/(featured|vedette)$/i) : false
                    }).length
                }

            },

            // Has thumbnail image?
            function ($doc, $alt) {
                var a = $doc.find('meta[property="og:image"]').attr('content')
                var b = $alt.find('meta[property="og:image"]').attr('content')

                if (!a) { return fail('Thumbnail image: Missing') }
                if (!b) { return fail('Thumbnail image: Missing on alternate language') }
                if (a === b) { return pass('Thumbnail image: Consistent between languages') }
                if (a !== b) { return fail('Thumbail image: Not consistent between languages') }
            },

            // Consistent Dates
            function ($doc, $alt, wp) {
                var a = $doc.find('#wb-dtmd time').text()
                var b = $alt ? $alt.find('#wb-dtmd time').text() : null

                if (a && b) {
                    a.should.equal(b)
                }


                // assert.equal(a, c, 'nooo why fail??')//.and.to.equal(c, 'ahhhh');

                //assert.fail( a == b == c, 'Not all dates match')


                if (!b && !c) { return log('Modified Date: Nothing to compare values with') }
                if (!c && a === b) { return pass('Modified Date: Consistent between languages') }
                if (!c && a !== b) { return fail('Modified Date: Inconsistent ( ' + a + ' and ' + b + ' )') }
                if (a === b && a !== c) { return fail('Modified Date: Consistent between languages, but not with WordPress') }
                if (a === b && a === c) { return pass('Modified Date: Consistent between languages and WordPress') }
            },



        ]

    </script>

</body>

</html>