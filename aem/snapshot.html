<!DOCTYPE html>
<html lang="en">

<head>
    <title>AEM - Snapshot</title>
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <script src="../lib/aem.js"></script>
</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item"><a href="index.html">AEM</a></li>
                    <li class="breadcrumb-item" aria-current="page">Snapshot</li>
                </ol>
            </nav>
            <p>Save a snapshot of a section of canada.ca for analysis.</p>
            <br />
            <div class="form-group row">
                <label for="root" class="col-sm-2 col-form-label">Root node</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control form-control-sm" id="root" value="en/department-national-defence/maple-leaf/defence/2021/04">
                </div>
            </div>
            <div class="form-group row">
                <label for="root" class="col-sm-2 col-form-label">Options</label>
                <div class="col-sm-10">
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="lang">
                        <label class="form-check-label" for="lang">Bilingual data</label>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="meta" checked="checked">
                        <label class="form-check-label" for="meta">JSON Metadata</label>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="html">
                        <label class="form-check-label" for="html">HTML document</label>
                    </div>
                </div>
            </div>
            <div id="progressbar" class="progress mb-2 mt-4" style="height: 5px">
                <div id="progress" class="progress-bar" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:main()">Click here to start</a></p>
        </div>
    </main>

    <script>

        // Current progress percentage
        var progress = 0
        var started = null

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') {
                progress = percent === 100 ? 100 : progress + percent
                return $progress.width(progress + '%')
            }
        }

        // Run program
        function main() {

            started = new Date().getTime()
            
            try {

                var opts = {
                    root: $('#root').val(),
                    lang: $('#lang').is(':checked'),
                    meta: $('#meta').is(':checked'),
                    html: $('#html').is(':checked')
                }

                if (!opts.root) {
                    throw 'Root node is required'
                }

                if (!opts.meta && !opts.html) {
                   throw 'No data is selected for download'
                }

                status('Finding nodes', 1)

                var list = $.Deferred()
                if (opts.lang) {
                    AEM.peer(opts.root, function (peer) {
                        $.when(
                            AEM.descendants(opts.root),
                            AEM.descendants(peer)
                        ).done(function (root, alt) {
                            list.resolve(root.concat(alt))
                        })
                    })
                } else {
                    list = AEM.descendants(opts.root)
                }

                list.done(function (nodes) {

                    // Make sure only canada.ca links
                    nodes = nodes.filter(function(val) {
                        return val.substr(0,22) === 'https://www.canada.ca/'
                    })


                    var req = (opts.meta ? nodes.length : 0) + (opts.html ? nodes.length : 0)
                    status('Downloading data (' + (req) + ' files)')

                    var data = []
                    var defers = []
                 
                    if (opts.meta) {
                        nodes.forEach(function(node, i){
                            defers.push(AEM.meta(node).done(function(meta){
                                status(null, 98 / req)

                                if (data[i]) {
                                    $.extend(data[i], meta)
                                } else {
                                    data[i] = meta
                                }
                            }))
                        })
                    }

                    if (opts.html) {
                        nodes.forEach(function(node, i){
                            defers.push(AEM.html(node).done(function(html){
                                status(null, 98 / req)

                                if (data[i]) {
                                    data[i].html = html
                                } else {
                                    data[i] = { html: html }
                                }
                            }))
                        })
                    }

                    $.when.apply(null, defers).done(function () {
                        status('Done (' + arguments.length + ' files, ' + (Math.round((new Date().getTime() - started) / 100) / 10) + ' seconds)', 100)
                        download(JSON.stringify(data, null, null), 'data.json', 'text/plain;charset=UTF-8;')
                    })

                })

            } catch (e) {
                status(e, 0)
            }
        }

    </script>

</body>

</html>