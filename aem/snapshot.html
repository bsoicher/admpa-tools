<!DOCTYPE html>
<html lang="en">

<head>
    <title>AEM - Snapshot</title>
    <meta charset="utf-8" />
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.2/async.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/string-strip-html/dist/string-strip-html.umd.js"></script>

    <script src="../lib/aem-snapshot.js"></script>
</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item"><a href="index.html">AEM</a></li>
                    <li class="breadcrumb-item" aria-current="page">Snapshot</li>
                </ol>
            </nav>
            <p>Save a snapshot of a section of canada.ca. The snapshots can be used for <a href="snapshot-search.html">metadata</a> or <a href="snapshot-html.html">HTML</a> searches analysis</a>.</p>
            <br />
            <div class="form-group row">
                <label for="root" class="col-sm-2 col-form-label">Root nodes <small>(1&nbsp;per&nbsp;line)</small></label>
                <div class="col-sm-10">
                    <textarea class="form-control" id="roots" rows="5">en/department-national-defence/maple-leaf/defence/2021/04</textarea>
                </div>
            </div>
            <div class="form-group row">
                <label for="root" class="col-sm-2 col-form-label">Options</label>
                <div class="col-sm-10">
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="lang" checked="checked">
                        <label class="form-check-label" for="lang">Bilingual data (Include both languages)</label>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="html" checked="checked">
                        <label class="form-check-label" for="html">Include HTML</label>
                    </div>
                    <div class="form-group form-check ms-3">
                        <input type="checkbox" class="form-check-input" id="clean">
                        <label class="form-check-label" for="clean">Content only (Removes <code>&lt;head&gt;</code>, <code>&lt;header&gt;</code>, <code>&lt;footer&gt;</code>, <code>&lt;details&gt;</code> and <code>&lt;script&gt;</code>)</label>
                    </div>

                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="meta" checked="checked">
                        <label class="form-check-label" for="meta">Include metadata</label>
                    </div>
                </div>
            </div>
            <div id="progressbar" class="progress mb-2 mt-3" style="height: 5px">
                <div id="complete" class="progress-bar" style="width:0%"></div>
                <div id="active" class="progress-bar bg-warning" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:main()">Click here to start</a></p>
        </div>
    </main>

    <script>

        // Globals
        var progress = 0
        var start = null
        var html = false

        function status(message) {
            if (message) {
                $('#status').html(message)
            }

            var p = aem.progress()
            $('#complete').width(p.complete)
            $('#active').width(p.active)
        }

        aem.preFilter = function (node) {
            return !node.path.includes('en/department-national-defence/services/caf-jobs') && !node.path.includes('fr/ministere-defense-nationale/services/emplois-fac')
        }

        // Run program
        function main() {
            var input = {
                roots: $('#roots').val().trim().split('\n'),
                html: $('#html').is(':checked'),
                clean: $('#clean').is(':checked'),
                meta: $('#meta').is(':checked'),
            }

            // Setup HTML filtering if needed
            if (input.clean) {
                aem.filterHtml = function (text) {
                    return stringStripHtml.stripHtml(text, {
                        onlyStripTags: ['head', 'script', 'header', 'footer', 'details'],
                        stripTogetherWithTheirContents: ['head', 'script', 'header', 'footer', 'details']
                    }).result
                }
            }

            // Add alternate roots if selected
            if ($('#lang').is(':checked')) {
                var chain = aem.meta(input.roots).wait().then(function () {
                    aem.each(function (node) {
                        if (node.peer) {
                            input.roots.push(node.peer)
                        }
                        return false
                    })
                })
            } else {
                var chain = $.when()
            }

            chain.then(function () {
                status('Downloading node lists')

                // Remove duplicates
                input.roots = input.roots.filter(function (v, i, a) {
                    return a.indexOf(v) === i;
                })

                // Find child nodes
                return aem.addRoot(input.roots).wait()

            }).then(function () {
                status('Downloading data')
                var nodes = aem.nodes()

                // Load html if selected
                if (input.html) {
                    aem.html(nodes)
                }

                // Load metadata if selected
                if (input.meta) {
                    aem.meta(nodes)
                }

                if (!aem.idle()) {
                    return aem.wait()
                }
            }).then(function () {
                status('Exporting data')

                // Convert to array
                var data = aem.nodes().map(function (path) {
                    return aem.data[path]
                })

                // Format data
                var json = utf8.encode(JSON.stringify(data))

                // Trigger file download
                download(json, 'snapshot.json', 'text/plain;charset=UTF-8;')
            })

        }

        setInterval(status, 250)

    </script>

</body>

</html>