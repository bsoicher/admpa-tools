<!DOCTYPE html>
<html lang="en">

<head>
    <title>AEM - Snapshot</title>
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <meta charset="utf-8" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Datatable -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables-buttons/2.2.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables-buttons/2.2.0/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables-buttons/2.2.0/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables-buttons/2.2.0/js/buttons.colVis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/vfs_fonts.min.js"></script>

    <script src="../lib/aem.js"></script>
</head>

<body>
    <main>
 
        <div class="row">

        
        <form class="form-inline">
            <div class="form-group mb-2">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="file" accept=".json" value="" />
                    <label class="custom-file-label" for="file" id="file-label"></label>
                </div>
            </div>
            <div class="form-group mb-2">

            </div>
        </form>
    </div>
        <div class="table-responsive mb-5">
            <table id="results" width="100%" class="table table-bordered table-sm"></table>
        </div>
    </main>

    <script>


        var table = $('#results').DataTable( {
            dom: 'frtipB',
            "regex": true,
            buttons: [
                { extend: 'copy', className: 'btn btn-light mr-1', exportOptions: { columns: ':visible' } },
                { extend: 'csv', className: 'btn btn-light mr-1', exportOptions: { columns: ':visible' } }, 
                { extend: 'excel', className: 'btn btn-light mr-1', exportOptions: { columns: ':visible' } }, 
                { extend: 'pdf', className: 'btn btn-light mr-1', exportOptions: { columns: ':visible' } }, 
                { extend: 'print', className: 'btn btn-light', exportOptions: { columns: ':visible' } }, 
            ],
            "columns": [
                {
                    title: 'SELF',
                    data: '_self',
                    defaultContent: '',
                    render: function(d) { 
                        a = '<a target="_blank" href="' + d + '">Link</a> '
                        a += '<a target="_blank" href="' + d.replace('.html', '/_jcr_content.json') + '">Meta</a>'
                        return a
                    }
                }, {
                    title: 'Language',
                    data: 'jcr:language',
                    defaultContent: '?',
                    render: function(d,t,r) { return d ? d : r._self ? r._self.match(/\/(en|fr)\//).pop() : null }
                },
                
                // Content
                { title: 'Title', data: 'jcr:title', defaultContent: '' },
                { title: 'Keywords', data: 'gcKeywords', defaultContent: '' },
                { title: 'Description', data: 'gcDescription', defaultContent: '' },
                { title: 'HTML', data: 'html', defaultContent: '', visible: false },
                
                // Dates
                { title: 'Last Published', data: 'gcLastPublished', type: 'date', defaultContent: '', visible: false },
                { title: 'Issued', data: 'gcIssued', type: 'date', defaultContent: '', visible: false },
                { title: 'Created', data: 'jcr:created', type: 'date', defaultContent: '', visible: false },
                { title: 'Last Modified', data: 'jcr:lastModified', type: 'date', defaultContent: '', visible: false }, 
                
            ]
        } );
       

        $('#results_filter').appendTo('#tnav');



        // Human readable byte count
        function formatSize(bytes) {
            if (bytes == 0) return '0 Byte'

            var sizes = ['Bytes', 'KB', 'MB', 'GB']
            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)))

            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i]
        }


        $('#file').change(function () {

            $(this).removeClass('is-valid is-invalid')

            var file = $(this).prop('files')[0]
            var read = new FileReader()

            if (file.type !== 'application/json') {
                throw 'Invalid file type ' + file.type
            }

            table.clear().draw()

            $('#file-label').html(file.name + ' - ' + formatSize(file.size))

            read.readAsText(file)

            read.onload = function () {
                data = JSON.parse(read.result)
                data.forEach(function(v){
                    table.row.add(v)
                })
                table.draw()
            }

        })

        

    </script>

</body>

</html>