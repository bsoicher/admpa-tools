<!DOCTYPE html>
<html lang="en">

<head>
    <title>Maple Leaf &gt; Freestyle Finder</title>

    <!-- Speed optimization -->
    <link rel="dns-prefetch" href="https://www.canada.ca">

    <!-- Meta -->
    <meta charset="utf-8" />
    <meta name="author" content="Ben Soicher" />

    <!-- Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../lib/aem.js"></script>
</head>

<body>
    <main>
        <div class="container mb-5">
            <h1 class="h4 mt-5">
                <a href="../index.html">ADMPA Web Tools</a>
                <small class="text-muted">&gt; General &gt; Freestyle Finder</small>
            </h1>
            <p>Analyze a site section for freestyle pages (Nodes under "en/department-national-defence")</p>
            <p>Note: Might take a while to run.</p>
            <h2 class="h5 mt-4 mb-3">Progress</h2>
            <div id="progressbar" class="progress my-2" style="height: 5px">
                <div id="progress" class="progress-bar" style="width:0%"></div>
            </div>
            <p id="status"><a href="javascript:main()">Click here to start</a></p>
            <pre id="list"></pre>
        </div>
    </main>

    <script>

        // Configure data sources
        var config = {
            'root': 'en/department-national-defence',
        }

        // Current progress percentage
        var progress = 0
        var started = null

        // Preselect elements
        var $status = $('#status')
        var $progress = $('#progress')

        // Set status message and/or progress
        function status(message, percent, error) {
            if (typeof message === 'string') { $status.html(message) }
            if (typeof percent === 'number') {
                progress = percent === 100 ? 100 : progress + percent
                return $progress.width(progress + '%')
            }
        }

        // Run program
        function main() {
            started = new Date().getTime()
            status('Initializing', 1)

            // Get AEM articles and process them
            AEM.descendants(config.root, function (urls) {
                status('Downloading metadata (' + (urls.length) + ' nodes)')

                urls.forEach(function(url, i, arr) {
                    isFreestyle(url, function(b) {
                        if (b) {
                            $('#list').append(url + '<br/>')
                        }
                    }).always(function(){
                        status(null, 99 / arr.length)
                    })
                })
            }).fail(function (e) {
                status('Error (' + e + '): ' + config.root)
            })

        }

        function isFreestyle(path, cb) {
            return $.Deferred(function (d) {
                AEM.meta(path).then(function (meta) {
                    d.notify(100).resolve(meta['cq:template'] === '/apps/canada/templates/mwsfreestyletemplate')
                }, function () {
                    d.notify(100).resolve(false)
                })
            }).done(cb).promise()
        }

    </script>

</body>

</html>