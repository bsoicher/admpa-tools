<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="author" content="Ben Soicher" />

    <title>CANFORGENS feed compiler</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.0.1/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
</head>

<body id="body">

    <!-- Actions -->
    <button onclick="start()">Run</button>

    <!-- Viewable log -->
    <pre id="log"></pre>

    <script>

        // Generate an AJAX task to be completed
        function get(url) {
            return async.retryable({
                times: 1,
                //interval: 15000
            }, function (cb) {
                jQuery.get({
                    url: url,
                    //cache: false,
                    //dataType: 'JSONP',
                    success: function (res) {cb(null, res) },
                    error: function (e) { cb(e, null) }
                })
            })
        }

        function log(str) {
            jQuery('#log').append(str + '<br/>')
        }

        // Start loading info
        function start() {

            // Perform functions in sequence
            async.waterfall([

                // Get list of years
                function (cb) {
                    log('Getting years...') 

                    async.parallel([
                        get('http://vcds.mil.ca/vcds-exec/pubs/canforgen/2020/001-20_e.asp'),
                    ], function (err, res) {

                        console.log(res)
                        cb(err, res)
                    })
                },

                // Turn XML sitemaps into JSON, filtering out URLs that dont match the format
                function (xml, cb) {
                    log('Processing sitemaps...')

                    var nodes = jQuery(xml).find('loc').map(function () {
                        return this.innerHTML
                    }).get().slice(1).filter(function (url) {
                        return url
                    })

                    cb(null, nodes)
                }

            ], function (e, data) {
                log('Done')
            })
        }

    </script>

</body>

</html>