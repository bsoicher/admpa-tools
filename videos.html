<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Video gallery feed compiler</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.0.1/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
</head>

<body id="body">

    <!-- Actions -->
    <button onclick="start()">Run</button>

    <!-- Viewable log -->
    <pre id="log"></pre>

    <script>

        // Generate an AJAX task to be completed
        function get(url) {
            return async.retryable({
                times: 2,
                interval: 60000
            }, function (cb) {
                jQuery.get({
                    url: url,
                    cache: false,
                    success: function (res) {cb(null, res) },
                    error: function (e) { cb(e, null) }
                })
            })
        }

        function log(str) {
            jQuery('#log').append(str + '<br/>')
        }

        // Start loading info
        function start() {

            // Perform functions in sequence
            async.waterfall([

                // Load AEM sitemaps
                function (cb) {
                    log('Loading sitemaps...')

                    async.parallel([
                        get('https://www.canada.ca/en/department-national-defence/corporate/video.sitemap.xml'),
                        get('https://www.canada.ca/fr/ministere-defense-nationale/organisation/video.sitemap.xml')
                    ], function (err, res) {
                        cb(err, res)
                    })
                },

                // Turn XML sitemaps into JSON, filtering out URLs that dont match the format
                function (xml, cb) {
                    log('Processing sitemaps...')

                    var nodes = jQuery(xml).find('loc').map(function () {
                        return this.innerHTML
                    }).get().slice(1).filter(function (url) {
                        return url
                    })

                    cb(null, nodes)
                },

                // Download metadata
                function (nodes, cb) {
                    log('Downloading metadata...')

                    var tasks = {}
                    nodes.forEach(function (url) {
                        tasks[url] = get(url.replace('.html', '/_jcr_content.json'))
                    })

                    async.parallelLimit(tasks, 5, function (err, meta) {
                        cb(err, meta)
                    })
                },

                // Process metadata
                function (meta, cb) {
                    log('Processing metadata...')
                    data = {en:[], fr:[]}

                    Object.keys(meta).forEach(function (url) {
                        try {
                            var o = meta[url]
                            var date = new Date(o['gcModifiedOverride'] || o['gcIssued'] || o['gcLastPublished']).toISOString()

                            data[o['jcr:language']].push([
                                o['gcOGImage'] ? '<img src="' + o['gcOGImage'] + '"/>' : '',
                                '<a href="' + url.replace('https://www.canada.ca/', '/') + '">' + utf8.encode(o['jcr:title']) + '</a>',
                                utf8.encode(o['gcDescription'] || ''),
                                utf8.encode(o['gcKeywords'] || '').replace(/,(\S)/g, ', $1'),
                                date.substr(0, 10) + '<em class="hidden">' + date.substr(10, 9) + '</em>'
                            ])
                        } catch (e) {
                            console.log(url)
                        }
                    })

                    cb(null, data)
                }

            ], function (e, data) {
                log('Done')

                for (var lang in data) {
                    download(JSON.stringify({ data: data[lang] }, null, null), lang + '.json', 'text/plain;charset=UTF-8;')
                }
            })
        }

    </script>

</body>

</html>