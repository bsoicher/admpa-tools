<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>Mobile App - CANFORGENS</title>

    <!-- Optimization -->
    <link rel="dns-prefetch" href="https://www.canada.ca">

    <!-- Style -->
    <link rel="icon" href="https://www.canada.ca/etc/designs/canada/wet-boew/assets/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css">
</head>

<body>
    <header>
        <nav class="navbar bg-dark shadow-sm">
            <div class="container-fluid px-4">
                <div class="navbar-brand">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="https://github.com/dnd-mdn" class="text-white">dnd-mdn</a></li>
                        <li class="breadcrumb-item"><a href="../index.html" class="text-white">Tools</a></li>
                        <li class="breadcrumb-item"><a href="../index.html?c=Mobile App" class="text-white">Mobile App</a></li>
                        <li class="breadcrumb-item active">CANFORGENS</li>
                    </ol>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container my-5">
            <h1 class="visually-hidden">CANFORGENS</h1>
            <p>Processes a CANFORGEN zip file and generates JSON. Zip files are generated by running the <code>.bat</code> file.</p>
            <input type="file" class="form-control" id="file" accept=".zip" value="" multiple/>
            <p id="status" class="mt-3">Select a <code>.zip</code> file to start</p>
        </div>
    </main>

    <!-- Scripting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/string.js/3.3.3/string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
    <script>

        $('#file').val(null).change(function () {
            $(this).prop('disabled', true).blur()
            var file = $(this).prop('files')[0]

            $('#file-label').text(file.name)

            readZip(file).catch(status)
 
        })

        // Extract metadata parts from file name
        function nameMeta(path) {
            let meta = path
                .toLowerCase()
                .match(/\/(?<year>\d{4})\/(?<id>[^_]+)_(?<lang>[ef])\./)

            if (!meta) {
                return null
            } else {
                meta = meta.groups
            }

            if (meta.id !== 't-of-c') {
                meta.id = meta.id.replace('-', '/')
            }

            return meta
        }

        // Decompress zip file contents
        function readZip(file) {

            return new Promise((resolve, reject) => {
                status('Loading file')

                var fr = new FileReader()

                fr.onload = () => resolve(fr.result)
                fr.onerror = reject
                fr.readAsBinaryString(file)
            }).then(binary => {
                status('Reading zip file contents')

                return JSZip.loadAsync(binary)
            }).then(async zip => {
                let files = {}

                for (name in zip.files) {
                    let info = nameMeta(name)

                    if (!info) {
                        console.info('Invalid file', name)
                    } else {
                        status(`Processing file "${name}"`)

                        files[name] = info
                        files[name].content = await zip.file(name).async('text')

                        if (info.id === 't-of-c') {
                            parseTOC(files[name])
                        } else {
                            parsePage(files[name])
                        }
                    }
                }

                return files
            }).then(files => {
                status('Creating data structure')
                let data = { e: {}, f: {} }

                for (name in files) {
                    let file = files[name]
                    let year = data[file.lang][file.year] || {}

                    if (!data[file.lang][file.year]) {
                        data[file.lang][file.year] = {}
                    }

                    data[file.lang][file.year][file.id] = file
                }

                // Verify consistent data
                for (year in data.e) {
                    if (!data.e[year]['t-of-c'] || !data.f[year]['t-of-c']) {
                        throw new Error('Missing table of contents', year)
                    }

                    for (id in data.e[year]) {
                        if (!data.f[year][id]) {
                            console.warn('Missing localization', id)
                            delete data.e[year][id]
                        }
                    }

                    for (id in data.f[year]) {
                        if (!data.e[year][id]) {
                            console.warn('Missing localization', id)
                            delete data.f[year][id]
                        }
                    }
                }

                console.log(JSON.parse(JSON.stringify(data)))

                // Distribute table of contents
                /*for (year in data) {
                    [ 'e', 'f'].forEach(lang => {

                        let list = data[year]['t-of-c'][lang].content

                        list.forEach(file => {
                            if (data[year][file.id]) {
                                Object.assign(data[year][file.id][lang], file)
                            } else {
                                console.info('TOC references missing file', file.id)
                            }
                        })

                        // Remove TOC
                        
                        delete data[year]['t-of-c']
                    })
                }*/
                
              
                return data
            }).then(data => {
                let e = data
                let f = {}

                // Split languages
                for (year in data) {
                    for (id in year) {
                        if (!f[year]) {
                            f[year] = {}
                        }

                        let file = data[year][id]
                        
                        f[year][id] = data[year][id].f
                        e[year][id] = data[year][id].e
                    }
                }

                console.log(e)
                console.log(f)


                let meta = {
                    'created': new Date() 
                }

                console.log(meta)
            })

        }


     


        let months = {
            'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
            'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12',
        }

        // Fix TOC errors...
        let fixTOC = {
            '1998': {
                '/058-98_e.asp">058/09</a>|': '/058-98_e.asp">058/98</a>|'
            },
            '2003': {
                '../2003/046-03': '046/03|311820Z MAR 03|CDS|CASH-OUT OF ACCRUED LEAVE PROGRAM 02/03',
                '|161503Z MAY 03|NNUAL': '|161503Z MAY 03|ADM (HR-Mil)|ANNUAL'
            },
            '2004': {
                '080-04_e.asp">80/04</a>': '080-04_e.asp">080/04</a>'
            },
            '2012': {
                'INTERARMEES 2012|http': 'INTERARMEES 2012\r\nhttp',
                '271542Z AUG 18</b>href': '271542Z AUG 18\r\nhref',
                '|021531Z APR 129|': '|021531Z APR 129|CANSOFCOM|',
            },
            '2015': {
                '|Sec G鮼PUBLICATION': '|Sec Gén|PUBLICATION'
            },
            '2017': {
                '015-17_f.asp">015/176</a>': '015-17_f.asp">015/17</a>'
            },
            date: {
                '05l6l0Z MAY 95': '051610Z MAY 95',
                'DEC 98': '071035Z DEC 98',
                '140Z MAY 98': '262140Z MAY 98',
                '300Z JUN 99': '111300Z JUN 99',
                '300Z JUN 00': '021300Z JUN 00',
                '910Z SEP 00': '250910Z SEP 00',
                '416Z FEB 01': '011416Z FEB 01',
                '119Z JUL 01': '241119Z JUL 01',
                '555Z AUG 01': '221555Z AUG 01',
                '020Z OCT 02': '171020Z OCT 02',
                '300Z DEC 02': '041300Z DEC 02',
                '311456Z MAY 044': '311456Z MAY 04',
                '825Z JUN 04': '031825Z JUN 04',
                'DEC 10': '171308Z DEC 10',
                '012359Z VCDS 11': '012359Z FEB 11',
                '1091228Z JUN 11': '091228Z JUN 11',
                '021531Z APR 129': '021531Z APR 12',
                '3281544Z JUL 14': '281544Z JUL 14',
            },
        }

        function parseTOC(file) {

            // Apply year fix if available
            if (fixTOC[file.year]) {
                for (fix in fixTOC[file.year]) {
                    file.content = file.content.replace(fix, fixTOC[file.year][fix])
                }
            }

            // Split into lines
            let lines = S(file.content).lines()

            // Ignore intro line
            lines.shift()

            // Loop through lines
            lines = lines.map((line, index, arr) => {
                let s = S(line)

                // Remove html formatting
                s = s.stripTags().decodeHTMLEntities()
                // Whitespace formatting
                s = s.collapseWhitespace()
                // Trim delimiters
                s = s.stripLeft('| ').stripRight('| ')
                // Skip empty lines
                if (s.isEmpty()) { return null }

                // Convert to array
                let a = s.split('|')

                // Skip incomplete lines
                if (a.length < 4) {
                    console.warn('Missing information', line)
                    return null
                }

                // Trim components
                a = a.map(s => s.trim())

                // Check for missing title
                if (S(a[3]).isEmpty()) {
                    console.warn('Missing title', line)
                    return null
                }

                // Try to format ID
                let m = a[0].match(/\d{3}[\/-]\d{2}$/)
                if (m) {
                    a[0] = m[0].replace('-', '/')
                } else {
                    console.warn('Unable to parse ID', line)
                    return null
                }

                // Apply date fix if available
                if (fixTOC.date[a[1]]) {
                    a[1] = fixTOC.date[a[1]]
                }

                // Try to format date to UTC
                m = a[1].match(/^(\d{2})(\d{2})(\d{2})Z ([a-z]{3})/i)
                if (m) {
                    a[1] = `${file.year}-${months[m[4]]}-${m[1]}T${m[2]}:${m[3]}:00Z`
                } else {
                    console.warn('Invalid date', line)
                    return null
                }

                // Log missing OPIs
                if (S(a[2]).isEmpty()) {
                    console.info('Empty OPI', line)
                }

                return {
                    id: a[0],
                    date: a[1],
                    opi: a[2],
                    subject: a[3],
                }
            })

            // Filter out null values
            file.content = lines.filter(x => x)
        }




        function parsePage(file) {
            let body = file.content.match(/<\s*body[^>]*>(.*)<\s*\/\s*body>/is)

            if (body) {
                body = S(body[1])
            } else {
                console.warn('Failed to locate <body> tag')
                return null
            }

            // Remove html comments
            body = body.replace(/<!--[\s\S]*?-->/g, '')
            // Condense whitespace
            body = body.trim().replace(/\s+/g, ' ').replace(/>\s+</g, '><')
            // Remove tags
            body = body.stripTags('font')
            // Convert empty p tags to br
            body = body.replace(/<p>\s*(&#160;|&#9;)?\s*<\/p>/gi, '<br>')


            // Links
            body = body.replace(/<a\s[^>]*href=\"([^\"]*)\"[^>]*>/i, (match, b) => {
                return '<AAAAAAAAAA>'
            })

            file.content = body.s
        }



        function save(data) {
            status('Saving <code>.json</code> files to downloads')

            download(JSON.stringify(data), 'data.json', 'text/plain;charset=UTF-8;')
        }


        let $status = $('#status')
        function status(message) {
            $status.html(message)

            if (message instanceof Error) {
                console.error(message)
            }
        }


    </script>

</body>

</html>