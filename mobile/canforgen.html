<!DOCTYPE html>
<html lang="en">

<head>
    <title>CANFORGEN</title>
    <link rel="dns-prefetch" href="https://www.canada.ca">
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/string.js/3.3.3/string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utf8/3.0.0/utf8.min.js"></script>
</head>

<body>
    <main>
        <div class="container my-5">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 h5">
                    <li class="breadcrumb-item"><a href="../index.html">ADMPA Web Tools</a></li>
                    <li class="breadcrumb-item current" aria-current="page">CANFORGEN</li>
                </ol>
            </nav>
            <p>Processes a CANFORGEN zip file and generates JSON. Zip files are generated by running the <code>.bat</code> file.</p>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="file" accept=".zip" value="" />
                <label class="custom-file-label" for="file" id="file-label">Select a <code>.zip</code> file</label>
            </div>
            <p id="status" class="mt-3">Waiting for zip file</p>
        </div>
    </main>

    <script>

        $('#file').change(function () {
            $(this).prop('disabled', true).blur()
            var file = $(this).prop('files')[0]

            $('#file-label').text(file.name)

            readZip(file)
                .then(verifyZip)
                .then(unZip)
                .then(processData)
                //.then(save)
                .catch(status)
                .finally(() => {
                    $('#file').prop('disabled', false)
                })

        })

        function readZip(file) {
            status('Reading file contents')

            return new Promise((resolve, reject) => {
                var fr = new FileReader()
                fr.onload = () => resolve(fr.result)
                fr.onerror = reject
                fr.readAsBinaryString(file)
            }).then(binary => {
                return JSZip.loadAsync(binary)
            })
        }

        function verifyZip(zip) {
            status('Verifying file contents')

            // Validate file names
            for (name in zip.files) {
                if (!name.match(/(^|\/)(\d{4})\/(t-of-c|[\d\-]+)_[ef]\.(txt|asp)$/i)) {
                    zip.remove(name)
                }
            }

            if (Object.keys(zip.files).length === 0) {
                throw new Error('Invalid file contents')
            }

            return zip
        }

        async function unZip(zip) {
            let data = {}

            for (name in zip.files) {
                status(`Extracting "${name}"`)

                let i = nameInfo(name)
                let text = await zip.file(name).async('text')

                // Create parent objects if needed
                if (!data[i.year]) { data[i.year] = {} }
                if (!data[i.year][i.id]) { data[i.year][i.id] = {} }

                data[i.year][i.id][i.lang] = {
                    text: text
                }
            }

            return data
        }

        function nameInfo(path) {
            return path
                .toLowerCase()
                .match(/\/(?<year>\d{4})\/(?<id>[^_]+)_(?<lang>[ef])\./)
                .groups
        }

        function processData(data) {

            // Process table of contents files
            for (year in data) {
                let e = data[year]['t-of-c'].e
                let f = data[year]['t-of-c'].f

                e.lines = parseTOC(e.text, year, 'e')
                f.lines = parseTOC(f.text, year, 'f')

                console.log(e.lines)
            }

            return data
        }


        let months = {
            'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
            'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12',
        }

        // Fix TOC errors...
        let fixTOC = {
            '2003': {
                '../2003/046-03': '046/03|311820Z MAR 03|CDS|CASH-OUT OF ACCRUED LEAVE PROGRAM 02/03',
                '|161503Z MAY 03|NNUAL': '|161503Z MAY 03|ADM (HR-Mil)|ANNUAL'
            },
            '2004': {
                '080-04_e.asp">80/04</a>': '080-04_e.asp">080/04</a>'
            },
            '2012': {
                'INTERARMEES 2012|http': 'INTERARMEES 2012\r\nhttp',
                '271542Z AUG 18</b>href': '271542Z AUG 18\r\nhref',
                '|021531Z APR 129|': '|021531Z APR 129|CANSOFCOM|',
            },
            '2015': {
                '|Sec G鮼PUBLICATION': '|Sec Gén|PUBLICATION'
            },
            '2017': {
                '015-17_f.asp">015/176</a>': '015-17_f.asp">015/17</a>'
            },
            date: {
                '05l6l0Z MAY 95': '051610Z MAY 95',
                'DEC 98': '071035Z DEC 98',
                '140Z MAY 98': '262140Z MAY 98',
                '300Z JUN 99': '111300Z JUN 99',
                '300Z JUN 00': '021300Z JUN 00',
                '910Z SEP 00': '250910Z SEP 00',
                '416Z FEB 01': '011416Z FEB 01',
                '119Z JUL 01': '241119Z JUL 01',
                '555Z AUG 01': '221555Z AUG 01',
                '020Z OCT 02': '171020Z OCT 02',
                '300Z DEC 02': '041300Z DEC 02',
                '311456Z MAY 044': '311456Z MAY 04',
                '825Z JUN 04': '031825Z JUN 04',
                'DEC 10': '171308Z DEC 10',
                '012359Z VCDS 11': '012359Z FEB 11',
                '1091228Z JUN 11': '091228Z JUN 11',
                '021531Z APR 129': '021531Z APR 12',
                '3281544Z JUL 14': '281544Z JUL 14',
            },
        }

        function parseTOC(text, year, lang) {

            // Apply year fix if available
            if (fixTOC[year]) {
                for (fix in fixTOC[year]) {
                    text = text.replace(fix, fixTOC[year][fix])
                }
            }

            // Split into lines
            let lines = S(text).lines()

            // Ignore intro line
            lines.shift()

            // Loop through lines
            lines = lines.map((line, index, arr) => {
                let s = S(line)

                // Remove html formatting
                s = s.stripTags().decodeHTMLEntities()
                // Whitespace formatting
                s = s.collapseWhitespace()
                // Trim delimiters
                s = s.stripLeft('| ').stripRight('| ')
                // Skip empty lines
                if (s.isEmpty()) { return null }

                // Convert to array
                let a = s.split('|')
                
                // Skip incomplete lines
                if (a.length < 4) {
                    console.warn('Missing information', line)
                    return null
                }

                // Trim components
                a = a.map(s => s.trim())

                // Check for missing title
                if (S(a[3]).isEmpty()) {
                    console.warn('Missing title', line)
                    return null
                }

                // Try to format ID
                let m = a[0].match(/\d{3}[\/-]\d{2}$/)
                if (m) {
                    a[0] = m[0]
                } else {
                    console.warn('Unable to parse ID', line)
                    return null
                }

                // Apply date fix if available
                if (fixTOC.date[a[1]]) { a[1] = fixTOC.date[a[1]] }

                // Try to format date to UTC
                m = a[1].match(/^(\d{2})(\d{2})(\d{2})Z ([a-z]{3})/i)
                if (m) {
                    a[1] = `${year}-${months[m[4]]}-${m[1]}T${m[2]}:${m[3]}:00Z`
                } else {
                    console.warn('Unable to parse date', line)
                    return null
                }

                // Log missing OPIs
                if (S(a[2]).isEmpty()) {
                    console.info('Missing OPI', line)
                }

                return {
                    id: a[0],
                    date: a[1],
                    opi: a[2],
                    title: a[3]
                }
            })

            // Filter out null values
            return lines.filter(x => x)
        }







        function save(data) {
            status('Saving <code>.json</code> files to downloads')

            download(JSON.stringify(data), 'data.json', 'text/plain;charset=UTF-8;')
        }


        let $status = $('#status')
        function status(message) {
            $status.html(message)
        }





    </script>

</body>

</html>